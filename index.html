<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTO-CAR Pro - Orçamentos Automotivos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        .brand-logo {
            font-weight: 300;
            font-size: 1.8rem;
        }
        nav {
            box-shadow: none;
        }
        .nav-wrapper {
            padding-left: 20px;
            padding-right: 20px;
        }
        .sidenav {
            width: 300px;
        }
        .sidenav li > a {
            font-weight: 400;
        }
        .sidenav .user-view {
            padding: 32px 32px 0;
        }
        .page-footer {
            padding-top: 0;
        }
        .tabs .tab a {
            color: #26a69a;
        }
        .tabs .tab a:hover, .tabs .tab a.active {
            color: #00796b;
        }
        .tabs .indicator {
            background-color: #00796b;
        }
        .card {
            border-radius: 8px;
        }
        .card-title {
            font-weight: 400;
        }
        .btn-large {
            border-radius: 24px;
        }
        .collection {
            border-radius: 8px;
        }
        .collection .collection-item {
            border-bottom: 1px solid #e0e0e0;
        }
        .collection .collection-item:last-child {
            border-bottom: none;
        }
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        .responsive-table {
            min-width: 800px;
            width: 100%;
        }
        .btn-floating .fab.fa-whatsapp {
            font-size: 1.3rem;
            line-height: 36px;
        }
        @media only screen and (max-width: 600px) {
            .btn-floating .fab.fa-whatsapp {
                font-size: 1.5rem;
            }
            .table-container {
                margin-left: -20px;
                margin-right: -20px;
                padding-left: 20px;
                padding-right: 20px;
            }
        }
        .dropdown-content {
            z-index: 9999 !important;
            opacity: 1 !important;
            position: fixed !important;
            top: 64px !important;
            right: 10px !important;
            left: auto !important;
            width: auto !important;
            max-width: 300px !important;
        }
        .tabs, .container {
            z-index: 1;
            position: relative;
        }
        .btn-floating.btn-small {
    margin-right: 5px;
}
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav>
        <div class="nav-wrapper teal darken-2">
            <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>
            <a href="#" class="brand-logo center">AUTO-CAR Pro</a>
            <ul class="right hide-on-med-and-down">
                <li><a class="dropdown-trigger" href="#!" data-target="dropdown-config"><i class="material-icons">settings</i></a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Dropdown Structure -->
    <ul id="dropdown-config" class="dropdown-content config-dropdown">
        <li><a href="#!" class="modal-link" onclick="abrirModalDadosEmpresa()"><i class="material-icons">business</i>Perfil da Empresa</a></li>
        <li><a href="#!" class="modal-link" onclick="abrirModalFormasPagamento()"><i class="material-icons">payment</i>Formas de Pagamento</a></li>
    </ul>

    <!-- Sidenav -->
    <ul id="slide-out" class="sidenav">
        <li>
            <div class="user-view">
                <div class="background teal darken-2"></div>
                <a href="#perfil"><img class="circle" src="/api/placeholder/100/100" alt="User Profile"></a>
                <a href="#perfil"><span class="white-text name">John Doe</span></a>
                <a href="#perfil"><span class="white-text email">johndoe@example.com</span></a>
            </div>
        </li>
        <li><a href="#dashboard" onclick="showSection('dashboard')"><i class="material-icons">dashboard</i>Dashboard</a></li>
        <li><a href="#novo-orcamento" onclick="showSection('novo-orcamento')"><i class="material-icons">add_circle</i>Novo Orçamento</a></li>
        <li><a href="#clientes" onclick="showSection('clientes')"><i class="material-icons">people</i>Clientes</a></li>
        <li><a href="#categorias" onclick="showSection('categorias')"><i class="material-icons">category</i>Categorias</a></li>
        <li>
            <div class="divider"></div>
        </li>
        <li><a class="subheader">Configurações</a></li>
        <li><a class="waves-effect" href="#!" onclick="abrirModalDadosEmpresa()"><i class="material-icons">business</i>Perfil da Empresa</a></li>
        <li><a class="waves-effect" href="#!" onclick="abrirModalFormasPagamento()"><i class="material-icons">payment</i>Formas de Pagamento</a></li>
    </ul>

    <!-- Conteúdo principal -->
    <div class="container">
        <!-- Abas de Navegação -->
        <div class="row">
            <div class="col s12">
                <ul class="tabs">
                    <li class="tab col s3"><a href="#dashboard" class="active">Dashboard</a></li>
                    <li class="tab col s3"><a href="#novo-orcamento">Novo Orçamento</a></li>
                    <li class="tab col s3"><a href="#clientes">Clientes</a></li>
                    <li class="tab col s3"><a href="#categorias">Categorias</a></li>
                </ul>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section">
            <h4 class="center-align">Dashboard</h4>
            <div class="row">
                <div class="col s12 m6 l3">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Orçamentos</span>
                            <h4 class="center-align" id="total-orcamentos">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col s12 m6 l3">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Clientes</span>
                            <h4 class="center-align" id="total-clientes">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col s12 m6 l3">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Categorias</span>
                            <h4 class="center-align" id="total-categorias">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col s12 m6 l3">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Faturamento</span>
                            <h4 class="center-align" id="total-faturamento">R$ 0,00</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Orçamentos Recentes</span>
                            <div class="table-container">
                                <table class="striped responsive-table">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Veículo</th>
                                            <th>Categoria</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>Compartilhar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orcamentos-recentes">
                                        <!-- Será preenchido dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Novo Orçamento -->
        <div id="novo-orcamento" class="section">
            <h4 class="center-align">Novo Orçamento</h4>
            <div class="row">
                <form id="orcamentoForm" class="col s12">
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <select id="cliente" required>
                                <option value="" disabled selected>Selecione o cliente</option>
                            </select>
                            <label>Cliente</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <select id="marca" required>
                                <option value="" disabled selected>Selecione a marca</option>
                            </select>
                            <label>Marca do Veículo</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <select id="modelo" disabled required>
                                <option value="" disabled selected>Selecione o modelo</option>
                            </select>
                            <label>Modelo do Veículo</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <select id="ano" disabled required>
                                <option value="" disabled selected>Selecione o ano</option>
                            </select>
                            <label>Ano do Veículo</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <select id="categoria" required>
                                <option value="" disabled selected>Selecione a categoria</option>
                            </select>
                            <label>Categoria</label>
                        </div>
                        <div class="input-field col s12">
                            <select multiple id="partesCarro">
                                <option value="" disabled>Selecione as partes do carro</option>
                                <option value="carro-completo-com-para-brisa">Carro completo com para-brisa</option>
                                <option value="carro-completo-sem-para-brisa">Carro completo sem para-brisa</option>
                                <option value="para-brisa-dianteiro">Para-brisa Dianteiro</option>
                                <option value="para-brisa-traseiro">Para-brisa Traseiro</option>
                                <option value="vidro-lateral-dianteiro-esquerdo">Vidro Lateral Dianteiro - Esquerdo</option>
                                <option value="vidro-lateral-dianteiro-direito">Vidro Lateral Dianteiro - Direito</option>
                                <option value="vidro-lateral-traseiro-esquerdo">Vidro Lateral Traseiro - Esquerdo</option>
                                <option value="vidro-lateral-traseiro-direito">Vidro Lateral Traseiro - Direito</option>
                                <option value="vidro-espia-dianteiro">Vidro Espia Dianteiro</option>
                                <option value="vidro-espia-traseiro">Vidro Espia Traseiro</option>
                                <option value="vidro-vigia">Vidro Vigia (Traseiro Central)</option>
                                <option value="teto-solar">Teto Solar</option>
                                <option value="faixa-15cm">Faixa 15cm</option>
                            </select>
                            <label>Partes do Carro</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <textarea id="observacoes" class="materialize-textarea"></textarea>
                            <label for="observacoes">Observações</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 center-align">
                            <button type="button" id="calcularOrcamentoBtn" class="btn-large waves-effect waves-light teal darken-2">Calcular Orçamento</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Clientes -->
        <div id="clientes" class="section">
            <h4 class="center-align">Clientes</h4>
            <div class="row">
                <div class="col s12">
                    <ul class="collection" id="lista-clientes">
                        <!-- Será preenchido dinamicamente -->
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col s12 center-align">
                    <a class="btn-large waves-effect waves-light teal darken-2 modal-trigger" href="#modal-novo-cliente">
                        <i class="material-icons left">add</i>Novo Cliente
                    </a>
                </div>
            </div>
        </div>

        <!-- Categorias -->
        <div id="categorias" class="section">
            <h4 class="center-align">Categorias de Películas</h4>
            <div class="row" id="lista-categorias">
                <!-- As categorias serão inseridas aqui -->
            </div>
        </div>
    </div>

    <!-- Modais -->
     <!-- Modal Detalhes da Categoria -->
<!-- Modal Editar Categoria -->
<div id="modal-categoria" class="modal">
    <div class="modal-content">
        <h4>Editar Categoria</h4>
        <form id="form-editar-categoria">
            <input type="hidden" id="categoria-id">
            <div class="input-field">
                <input id="categoria-nome" type="text" class="validate" disabled>
                <label for="categoria-nome">Nome da Categoria</label>
            </div>
            <div class="input-field">
                <input id="categoria-preco" type="number" step="0.01" min="0" class="validate" required>
                <label for="categoria-preco">Preço (R$)</label>
            </div>
            <div class="input-field">
                <textarea id="categoria-descricao" class="materialize-textarea"></textarea>
                <label for="categoria-descricao">Descrição</label>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
        <a href="#!" class="waves-effect waves-green btn teal" onclick="salvarEdicaoCategoria()">Salvar</a>
    </div>
</div>
    <!-- Modal Dados da Empresa -->
    <div id="modal-dados-empresa" class="modal">
        <div class="modal-content">
            <h4>Dados da Empresa</h4>
            <form id="formDadosEmpresa">
                <div class="row">
                    <div class="input-field col s12">
                        <input id="nome_empresa" type="text" class="validate" required>
                        <label for="nome_empresa">Nome da Empresa</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="cnpj_empresa" type="text" class="validate" required>
                        <label for="cnpj_empresa">CNPJ</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="endereco_empresa" type="text" class="validate" required>
                        <label for="endereco_empresa">Endereço</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s6">
                        <input id="telefone_empresa" type="tel" class="validate" required>
                        <label for="telefone_empresa">Telefone</label>
                    </div>
                    <div class="input-field col s6">
                        <input id="email_empresa" type="email" class="validate" required>
                        <label for="email_empresa">E-mail</label>
                    </div>
                </div>
                <div class="row">
                    <div class="file-field input-field">
                        <div class="btn">
                            <span>Logo</span>
                            <input type="file" id="logo_empresa" accept="image/*">
                        </div>
                        <div class="file-path-wrapper">
                            <input class="file-path validate" type="text">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
            <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="salvarDadosEmpresa()">Salvar</a>
        </div>
    </div>

    <!-- Modal Formas de Pagamento -->
    <div id="modal-formas-pagamento" class="modal">
        <div class="modal-content">
            <h4>Formas de Pagamento</h4>
            <form id="formFormasPagamento">
                <div class="row">
                    <div class="input-field col s12">
                        <input id="chave_pix" type="text" class="validate">
                        <label for="chave_pix">Chave PIX</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <select multiple id="prazos_boleto">
                            <option value="15">15 dias</option>
                            <option value="30">30 dias</option>
                            <option value="45">45 dias</option>
                            <option value="60">60 dias</option>
                            <option value="90">90 dias</option>
                        </select>
                        <label>Prazos de Boleto</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s6">
                        <input id="parcelas_sem_juros" type="number" class="validate" min="1">
                        <label for="parcelas_sem_juros">Parcelas sem Juros</label>
                    </div>
                    <div class="input-field col s6">
                        <input id="parcelas_com_juros" type="number" class="validate" min="1">
                        <label for="parcelas_com_juros">Parcelas com Juros</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12">
                        <input id="taxa_juros" type="number" step="0.1" class="validate" min="0">
                        <label for="taxa_juros">Taxa de Juros (%)</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
            <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="salvarFormasPagamento()">Salvar</a>
        </div>
    </div>

    <!-- Modal Novo Cliente -->
    <div id="modal-novo-cliente" class="modal">
        <div class="modal-content">
            <h4>Novo Cliente</h4>
            <form id="formNovoCliente">
                <div class="row">
                    <div class="input-field col s12">
                        <input id="nome_cliente" type="text" class="validate" required>
                        <label for="nome_cliente">Nome Completo</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12 m6">
                        <input id="email_cliente" type="email" class="validate" required>
                        <label for="email_cliente">E-mail</label>
                    </div>
                    <div class="input-field col s12 m6">
                        <input id="telefone_cliente" type="tel" class="validate" required>
                        <label for="telefone_cliente">Telefone</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
            <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="salvarNovoCliente()">Salvar</a>
        </div>
    </div>

    <!-- Modal Editar Cliente -->
    <div id="modal-editar-cliente" class="modal">
        <div class="modal-content">
            <h4>Editar Cliente</h4>
            <form id="formEditarCliente">
                <input type="hidden" id="id_cliente_edit">
                <div class="row">
                    <div class="input-field col s12">
                        <input id="nome_cliente_edit" type="text" class="validate" required>
                        <label for="nome_cliente_edit">Nome Completo</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12 m6">
                        <input id="email_cliente_edit" type="email" class="validate" required>
                        <label for="email_cliente_edit">E-mail</label>
                    </div>
                    <div class="input-field col s12 m6">
                        <input id="telefone_cliente_edit" type="tel" class="validate" required>
                        <label for="telefone_cliente_edit">Telefone</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
            <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="atualizarCliente()">Atualizar</a>
        </div>
    </div>

    <!-- Modal Resultado Orçamento -->
    <div id="modal-resultado-orcamento" class="modal">
        <div class="modal-content" id="resultado-orcamento-content">
            <!-- O conteúdo será preenchido dinamicamente -->
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Fechar</a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="page-footer teal darken-2">
        <div class="container">
            © 2024 AUTO-CAR Pro
            <a class="grey-text text-lighten-4 right" href="#!">Termos de Uso</a>
        </div>
    </footer>


<!-- Scripts do Materialize e jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
 
<script>
// Parte 1: Inicialização do IndexedDB e Manipulação de Dados

let db;
const dbName = 'AutoCarDB';
const dbVersion = 1;



// Abre uma conexão com o banco de dados IndexedDB
const request = indexedDB.open(dbName, dbVersion);

request.onerror = function(event) {
    console.error("Erro ao abrir o banco de dados:", event.target.error);
};

request.onsuccess = function(event) {
    db = event.target.result;
    console.log("Banco de dados aberto com sucesso");
    carregarDados(); // Carrega os dados iniciais após a conexão ser estabelecida
};

request.onupgradeneeded = function(event) {
    db = event.target.result;

    // Cria o object store para clientes, se não existir
    if (!db.objectStoreNames.contains('clientes')) {
        const clientesStore = db.createObjectStore('clientes', { keyPath: 'id', autoIncrement: true });
        clientesStore.createIndex('nome', 'nome', { unique: false });
        clientesStore.createIndex('email', 'email', { unique: true });
    }

    // Cria o object store para categorias, se não existir
    if (!db.objectStoreNames.contains('categorias')) {
        const categoriasStore = db.createObjectStore('categorias', { keyPath: 'id', autoIncrement: true });
        categoriasStore.createIndex('nome', 'nome', { unique: true });

        // Adiciona categorias fixas ao object store de categorias
        const categorias = [
            "Nanocerâmico", "Nano Carbono", "Fotocromático", "Semi-refletiva",
            "Refletiva", "Antivandalismo", "Profissional", "Pigmentada",
            "Sputtering", "Híbrido", "Electrochromic"
        ];

        categorias.forEach((categoria, index) => {
            categoriasStore.add({ id: index + 1, nome: categoria });
        });
    }

    // Cria o object store para orçamentos, se não existir
    if (!db.objectStoreNames.contains('orcamentos')) {
        const orcamentosStore = db.createObjectStore('orcamentos', { keyPath: 'id', autoIncrement: true });
        orcamentosStore.createIndex('clienteId', 'clienteId', { unique: false });
        orcamentosStore.createIndex('data', 'data', { unique: false });
    }

    // Cria o object store para configurações, se não existir
    if (!db.objectStoreNames.contains('configuracoes')) {
        const configuracoesStore = db.createObjectStore('configuracoes', { keyPath: 'id' });
        configuracoesStore.createIndex('nome', 'nome', { unique: false });
    }
};

// Função para converter imagem em Base64
function converterImagemParaBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Declarações globais
const precosBaseParte = {
    'carro-completo-com-para-brisa': 1,
    'carro-completo-sem-para-brisa': 0.9,
    'para-brisa-dianteiro': 0.3,
    'para-brisa-traseiro': 0.25,
    'vidro-lateral-dianteiro-esquerdo': 0.15,
    'vidro-lateral-dianteiro-direito': 0.15,
    'vidro-lateral-traseiro-esquerdo': 0.15,
    'vidro-lateral-traseiro-direito': 0.15,
    'vidro-espia-dianteiro': 0.05,
    'vidro-espia-traseiro': 0.05,
    'vidro-vigia': 0.2,
    'teto-solar': 0.25,
    'faixa-15cm': 0.1
};

async function calcularPrecoTotal(categoriaId, partesSelecionadas) {
    const categoria = await buscarCategoriaPorId(categoriaId);
    if (!categoria || !categoria.preco) {
        throw new Error('Categoria não encontrada ou sem preço definido');
    }

    let fatorTotal = 0;
    partesSelecionadas.forEach(parte => {
        fatorTotal += precosBaseParte[parte] || 0;
    });

    // Se nenhuma parte foi selecionada ou o fator total é maior que 1, 
    // consideramos como um carro completo
    if (fatorTotal === 0 || fatorTotal > 1) {
        fatorTotal = 1;
    }

    return categoria.preco * fatorTotal;
}


// Função para buscar dados da empresa no IndexedDB
async function buscarDadosEmpresa() {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['configuracoes'], 'readonly');
        const store = transaction.objectStore('configuracoes');
        const request = store.get('dadosEmpresa');

        request.onerror = function(event) {
            console.error("Erro ao buscar dados da empresa:", event.target.error);
            reject("Erro ao buscar dados da empresa: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para salvar dados da empresa no IndexedDB
async function salvarDadosEmpresaNoIndexedDB(dadosEmpresa) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['configuracoes'], 'readwrite');
        const store = transaction.objectStore('configuracoes');
        const request = store.put({ id: 'dadosEmpresa', ...dadosEmpresa });

        request.onerror = function(event) {
            reject("Erro ao salvar dados da empresa: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para buscar todas as categorias do IndexedDB
async function buscarTodasCategorias() {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['categorias'], 'readonly');
        const store = transaction.objectStore('categorias');
        const request = store.getAll();

        request.onerror = function(event) {
            reject("Erro ao buscar categorias: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para buscar todos os clientes do IndexedDB
async function buscarTodosClientes() {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['clientes'], 'readonly');
        const store = transaction.objectStore('clientes');
        const request = store.getAll();

        request.onerror = function(event) {
            reject("Erro ao buscar clientes: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para buscar todos os orçamentos do IndexedDB
async function buscarTodosOrcamentos() {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['orcamentos'], 'readonly');
        const store = transaction.objectStore('orcamentos');
        const request = store.getAll();

        request.onerror = function(event) {
            reject("Erro ao buscar orçamentos: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para buscar um cliente pelo ID no IndexedDB
async function buscarClientePorId(id) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['clientes'], 'readonly');
        const store = transaction.objectStore('clientes');
        const request = store.get(id);

        request.onerror = function(event) {
            reject("Erro ao buscar cliente: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para buscar um orçamento pelo ID no IndexedDB
async function buscarOrcamentoPorId(id) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['orcamentos'], 'readonly');
        const store = transaction.objectStore('orcamentos');
        const request = store.get(parseInt(id));

        request.onerror = function(event) {
            reject("Erro ao buscar orçamento: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para buscar uma categoria pelo ID no IndexedDB
async function buscarCategoriaPorId(id) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['categorias'], 'readonly');
        const store = transaction.objectStore('categorias');
        const request = store.get(id);

        request.onerror = function(event) {
            reject("Erro ao buscar categoria: " + event.target.error);
        };

        request.onsuccess = function(event) {
            const categoria = event.target.result;
            if (categoria) {
                // Adicione campos padrão se não existirem
                categoria.preco = categoria.preco || 0;
                categoria.descricao = categoria.descricao || 'Sem descrição';
            }
            resolve(categoria);
        };
    });
}

// Função para salvar formas de pagamento no IndexedDB
async function salvarFormasPagamentoNoIndexedDB(formasPagamento) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['configuracoes'], 'readwrite');
        const store = transaction.objectStore('configuracoes');
        const request = store.put({ id: 'formasPagamento', ...formasPagamento });

        request.onerror = function(event) {
            reject("Erro ao salvar formas de pagamento: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para buscar formas de pagamento do IndexedDB
async function buscarFormasPagamento() {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['configuracoes'], 'readonly');
        const store = transaction.objectStore('configuracoes');
        const request = store.get('formasPagamento');

        request.onerror = function(event) {
            reject("Erro ao buscar formas de pagamento: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para adicionar um novo cliente ao IndexedDB
async function adicionarCliente(cliente) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['clientes'], 'readwrite');
        const store = transaction.objectStore('clientes');
        const request = store.add(cliente);

        request.onerror = function(event) {
            reject("Erro ao adicionar cliente: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para atualizar um cliente no IndexedDB
async function atualizarClienteDB(cliente) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['clientes'], 'readwrite');
        const store = transaction.objectStore('clientes');
        const request = store.put(cliente);

        request.onerror = function(event) {
            reject("Erro ao atualizar cliente: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Função para adicionar um novo orçamento ao IndexedDB
async function adicionarOrcamento(orcamento) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['orcamentos'], 'readwrite');
        const store = transaction.objectStore('orcamentos');
        const request = store.add(orcamento);

        request.onerror = function(event) {
            reject("Erro ao adicionar orçamento: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}
// Parte 2: Funções de Configuração da Empresa e Formas de Pagamento

// Função para abrir o modal de dados da empresa
function abrirModalDadosEmpresa() {
    carregarDadosEmpresa();
    var modal = M.Modal.getInstance(document.getElementById('modal-dados-empresa'));
    modal.open();
}

// Função para carregar os dados da empresa nos campos do modal
async function carregarDadosEmpresa() {
    const dadosEmpresa = await buscarDadosEmpresa();
    if (dadosEmpresa) {
        document.getElementById('nome_empresa').value = dadosEmpresa.nome || '';
        document.getElementById('cnpj_empresa').value = dadosEmpresa.cnpj || '';
        document.getElementById('endereco_empresa').value = dadosEmpresa.endereco || '';
        document.getElementById('telefone_empresa').value = dadosEmpresa.telefone || '';
        document.getElementById('email_empresa').value = dadosEmpresa.email || '';
        if (dadosEmpresa.logo) {
            // Exibir logo, se necessário
            // Por exemplo, você pode adicionar uma tag <img> para mostrar a logo
            // Exemplo:
            // document.getElementById('logo_preview').src = dadosEmpresa.logo;
        }
        M.updateTextFields(); // Atualiza os campos de texto do Materialize
    }
}

// Função para salvar os dados da empresa inseridos no modal
async function salvarDadosEmpresa() {
    const dadosEmpresa = {
        nome: document.getElementById('nome_empresa').value,
        cnpj: document.getElementById('cnpj_empresa').value,
        endereco: document.getElementById('endereco_empresa').value,
        telefone: document.getElementById('telefone_empresa').value,
        email: document.getElementById('email_empresa').value
    };

    const logoInput = document.getElementById('logo_empresa');
    if (logoInput.files.length > 0) {
        dadosEmpresa.logo = await converterImagemParaBase64(logoInput.files[0]);
    }

    try {
        await salvarDadosEmpresaNoIndexedDB(dadosEmpresa);
        M.toast({html: 'Dados da empresa salvos com sucesso!', classes: 'rounded'});
        M.Modal.getInstance(document.getElementById('modal-dados-empresa')).close();
    } catch (error) {
        M.toast({html: 'Erro ao salvar dados da empresa: ' + error, classes: 'rounded red'});
    }
}

// Função para abrir o modal de formas de pagamento
function abrirModalFormasPagamento() {
    carregarFormasPagamento();
    var modal = M.Modal.getInstance(document.getElementById('modal-formas-pagamento'));
    modal.open();
}

// Função para carregar as formas de pagamento nos campos do modal
async function carregarFormasPagamento() {
    const formasPagamento = await buscarFormasPagamento();
    if (formasPagamento) {
        document.getElementById('chave_pix').value = formasPagamento.chavePIX || '';
        document.getElementById('parcelas_sem_juros').value = formasPagamento.parcelasSemJuros || '';
        document.getElementById('parcelas_com_juros').value = formasPagamento.parcelasComJuros || '';
        document.getElementById('taxa_juros').value = formasPagamento.taxaJuros || '';

        // Carregar os prazos de boleto
        if (formasPagamento.prazosBoleto) {
            const prazosSelect = document.getElementById('prazos_boleto');
            Array.from(prazosSelect.options).forEach(option => {
                if (formasPagamento.prazosBoleto.includes(option.value)) {
                    option.selected = true;
                }
            });
        }

        M.FormSelect.init(document.getElementById('prazos_boleto'));
        M.updateTextFields(); // Atualiza os campos de texto do Materialize
    }
}

// Função para salvar as formas de pagamento a partir do modal
async function salvarFormasPagamento() {
    const chavePIX = document.getElementById('chave_pix').value;
    const prazosBoleto = Array.from(document.getElementById('prazos_boleto').selectedOptions).map(option => option.value);
    const parcelasSemJuros = parseInt(document.getElementById('parcelas_sem_juros').value) || 0;
    const parcelasComJuros = parseInt(document.getElementById('parcelas_com_juros').value) || 0;
    const taxaJuros = parseFloat(document.getElementById('taxa_juros').value) || 0;

    const formasPagamento = {
        chavePIX,
        prazosBoleto,
        parcelasSemJuros,
        parcelasComJuros,
        taxaJuros
    };

    try {
        await salvarFormasPagamentoNoIndexedDB(formasPagamento);
        M.toast({html: 'Formas de pagamento salvas com sucesso!', classes: 'rounded'});
        M.Modal.getInstance(document.getElementById('modal-formas-pagamento')).close();
    } catch (error) {
        console.error('Erro ao salvar formas de pagamento:', error);
        M.toast({html: 'Erro ao salvar formas de pagamento: ' + error, classes: 'rounded red'});
    }
}
// Parte 3: Funções de Gestão de Clientes (CRUD)

// Função para carregar a lista de clientes na interface
async function carregarClientes() {
    const clientes = await buscarTodosClientes();
    const listaClientes = document.getElementById('lista-clientes');
    const selectCliente = document.getElementById('cliente');

    listaClientes.innerHTML = '';
    selectCliente.innerHTML = '<option value="" disabled selected>Selecione o cliente</option>';

    clientes.forEach(cliente => {
        // Adiciona o cliente na lista visual
        listaClientes.innerHTML += `
            <li class="collection-item" style="position: relative; padding-right: 48px; min-height: 65px;">
                <div style="padding-right: 40px;">
                    <span class="title" style="font-weight: bold; display: block; color: #00796b;">${cliente.nome}</span>
                    <p style="margin: 0; font-size: 0.9em; color: rgba(0,0,0,0.7);">
                        ${cliente.email}<br>
                        ${cliente.telefone}
                    </p>
                </div>
                <div style="position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column;">
                    <a href="#!" onclick="editarCliente(${cliente.id})" style="margin-bottom: 5px; color: #00796b;">
                        <i class="material-icons" style="font-size: 20px;">edit</i>
                    </a>
                    <a href="#!" onclick="confirmarExclusaoCliente(${cliente.id})" style="color: #00796b;">
                        <i class="material-icons" style="font-size: 20px;">delete</i>
                    </a>
                </div>
            </li>
        `;

        // Adiciona o cliente no select do formulário de orçamento
        selectCliente.innerHTML += `<option value="${cliente.id}">${cliente.nome}</option>`;
    });

    M.FormSelect.init(selectCliente);
}

// Função para salvar um novo cliente a partir do formulário
async function salvarNovoCliente() {
    const nome = document.getElementById('nome_cliente').value;
    const email = document.getElementById('email_cliente').value;
    const telefone = document.getElementById('telefone_cliente').value;

    try {
        await adicionarCliente({ nome, email, telefone });
        M.toast({html: 'Cliente salvo com sucesso!', classes: 'rounded'});
        document.getElementById('formNovoCliente').reset();
        M.Modal.getInstance(document.getElementById('modal-novo-cliente')).close();
        await carregarClientes();
        atualizarDashboard();
    } catch (error) {
        M.toast({html: 'Erro ao salvar cliente: ' + error, classes: 'rounded red'});
    }
}

// Função para editar um cliente existente
function editarCliente(id) {
    buscarClientePorId(id).then(cliente => {
        document.getElementById('id_cliente_edit').value = cliente.id;
        document.getElementById('nome_cliente_edit').value = cliente.nome;
        document.getElementById('email_cliente_edit').value = cliente.email;
        document.getElementById('telefone_cliente_edit').value = cliente.telefone;
        M.updateTextFields(); // Atualiza os campos de texto do Materialize
        M.Modal.getInstance(document.getElementById('modal-editar-cliente')).open();
    }).catch(error => {
        console.error('Erro ao buscar cliente para edição:', error);
        M.toast({html: 'Erro ao buscar cliente para edição: ' + error, classes: 'rounded red'});
    });
}

// Função para salvar as alterações de um cliente editado
async function atualizarCliente() {
    const id = parseInt(document.getElementById('id_cliente_edit').value);
    const nome = document.getElementById('nome_cliente_edit').value;
    const email = document.getElementById('email_cliente_edit').value;
    const telefone = document.getElementById('telefone_cliente_edit').value;

    try {
        await atualizarClienteDB({ id, nome, email, telefone });
        M.toast({html: 'Cliente atualizado com sucesso!', classes: 'rounded'});
        M.Modal.getInstance(document.getElementById('modal-editar-cliente')).close();
        await carregarClientes();
        atualizarDashboard();
    } catch (error) {
        M.toast({html: 'Erro ao atualizar cliente: ' + error, classes: 'rounded red'});
    }
}

// Função para confirmar e excluir um cliente
function confirmarExclusaoCliente(id) {
    if (confirm('Tem certeza que deseja excluir este cliente?')) {
        excluirCliente(id).then(() => {
            M.toast({html: 'Cliente excluído com sucesso!', classes: 'rounded'});
            carregarClientes();
            atualizarDashboard();
        }).catch(error => {
            M.toast({html: 'Erro ao excluir cliente: ' + error, classes: 'rounded red'});
        });
    }
}

// Função para excluir um cliente do IndexedDB
async function excluirCliente(id) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['clientes'], 'readwrite');
        const store = transaction.objectStore('clientes');
        const request = store.delete(id);

        request.onerror = function(event) {
            reject("Erro ao excluir cliente: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve();
        };
    });
}
// Parte 4: Funções de Cálculo de Orçamento, Compartilhamento e Inicialização da Interface

// Função para carregar as marcas de veículos no select
async function loadBrands() {
    const BASE_URL = 'https://parallelum.com.br/fipe/api/v1/carros';

    const marcaSelect = document.getElementById('marca');
    const modeloSelect = document.getElementById('modelo');
    const anoSelect = document.getElementById('ano');

    marcaSelect.innerHTML = '<option value="" disabled selected>Selecione a marca</option>';

    try {
        const response = await fetch(`${BASE_URL}/marcas`);
        if (!response.ok) {
            throw new Error(`Erro ao buscar marcas: ${response.status}`);
        }
        const brands = await response.json();

        brands.forEach(brand => {
            marcaSelect.innerHTML += `<option value="${brand.codigo}">${brand.nome}</option>`;
        });

        M.FormSelect.init(marcaSelect);
    } catch (error) {
        console.error('Erro ao carregar marcas:', error);
        M.toast({html: 'Erro ao carregar marcas. Por favor, tente novamente.', classes: 'rounded red'});
    }
}

// Evento ao selecionar uma marca para carregar os modelos
document.getElementById('marca').addEventListener('change', async function() {
    const marcaId = this.value;
    const modeloSelect = document.getElementById('modelo');
    const anoSelect = document.getElementById('ano');

    modeloSelect.innerHTML = '<option value="" disabled selected>Selecione o modelo</option>';
    anoSelect.innerHTML = '<option value="" disabled selected>Selecione o ano</option>';
    modeloSelect.disabled = true;
    anoSelect.disabled = true;

    if (marcaId) {
        modeloSelect.disabled = false;
        try {
            const response = await fetch(`https://parallelum.com.br/fipe/api/v1/carros/marcas/${marcaId}/modelos`);
            if (!response.ok) {
                throw new Error(`Erro ao buscar modelos: ${response.status}`);
            }
            const modelsData = await response.json();
            modelsData.modelos.forEach(model => {
                modeloSelect.innerHTML += `<option value="${model.codigo}">${model.nome}</option>`;
            });
            M.FormSelect.init(modeloSelect);
        } catch (error) {
            console.error('Erro ao carregar modelos:', error);
            M.toast({html: 'Erro ao carregar modelos. Por favor, tente novamente.', classes: 'rounded red'});
        }
    }
});

// Evento ao selecionar um modelo para carregar os anos
document.getElementById('modelo').addEventListener('change', async function() {
    const marcaId = document.getElementById('marca').value;
    const modeloId = this.value;
    const anoSelect = document.getElementById('ano');

    anoSelect.innerHTML = '<option value="" disabled selected>Selecione o ano</option>';
    anoSelect.disabled = true;

    if (modeloId) {
        anoSelect.disabled = false;
        try {
            const response = await fetch(`https://parallelum.com.br/fipe/api/v1/carros/marcas/${marcaId}/modelos/${modeloId}/anos`);
            if (!response.ok) {
                throw new Error(`Erro ao buscar anos: ${response.status}`);
            }
            const years = await response.json();
            years.forEach(year => {
                anoSelect.innerHTML += `<option value="${year.codigo}">${year.nome}</option>`;
            });
            M.FormSelect.init(anoSelect);
        } catch (error) {
            console.error('Erro ao carregar anos:', error);
            M.toast({html: 'Erro ao carregar anos. Por favor, tente novamente.', classes: 'rounded red'});
        }
    }
});

// Modifique a função carregarCategorias para incluir o preço na exibição
async function carregarCategorias() {
    const categorias = await buscarTodasCategorias();
    const listaCategorias = document.getElementById('lista-categorias');
    const categoriaSelect = document.getElementById('categoria');

    listaCategorias.innerHTML = '';
    categoriaSelect.innerHTML = '<option value="" disabled selected>Selecione a categoria</option>';

    categorias.forEach(categoria => {
        // Adiciona a categoria na visualização
        listaCategorias.innerHTML += `
            <div class="col s12 m6 l4">
                <div class="card hoverable">
                    <div class="card-content">
                        <span class="card-title">${categoria.nome}</span>
                        <p>Preço: R$ ${categoria.preco ? categoria.preco.toFixed(2) : 'Não definido'}</p>
                        <a href="#!" class="btn-floating halfway-fab waves-effect waves-light teal" onclick="abrirModalCategoria(${categoria.id})">
                            <i class="material-icons">edit</i>
                        </a>
                    </div>
                </div>
            </div>
        `;

        // Adiciona a categoria no select do formulário de orçamento
        categoriaSelect.innerHTML += `<option value="${categoria.id}">${categoria.nome}</option>`;
    });

    M.FormSelect.init(categoriaSelect);
}

// Função para abrir o modal com os detalhes da categoria para edição
async function abrirModalCategoria(categoriaId) {
    try {
        const categoria = await buscarCategoriaPorId(categoriaId);
        if (!categoria) throw new Error('Categoria não encontrada');

        document.getElementById('categoria-id').value = categoria.id;
        document.getElementById('categoria-nome').value = categoria.nome;
        document.getElementById('categoria-preco').value = categoria.preco || '';
        document.getElementById('categoria-descricao').value = categoria.descricao || '';

        M.updateTextFields();
        M.textareaAutoResize(document.getElementById('categoria-descricao'));

        const modal = M.Modal.getInstance(document.getElementById('modal-categoria'));
        modal.open();
    } catch (error) {
        console.error('Erro ao abrir modal de categoria:', error);
        M.toast({html: 'Erro ao carregar detalhes da categoria', classes: 'rounded red'});
    }
}
// Função para salvar a edição da categoria
async function salvarEdicaoCategoria() {
    const id = parseInt(document.getElementById('categoria-id').value);
    const nome = document.getElementById('categoria-nome').value;
    const preco = parseFloat(document.getElementById('categoria-preco').value);
    const descricao = document.getElementById('categoria-descricao').value;

    if (isNaN(preco) || preco < 0) {
        M.toast({html: 'Por favor, insira um preço válido', classes: 'rounded red'});
        return;
    }

    try {
        await atualizarCategoria({ id, nome, preco, descricao });
        M.toast({html: 'Categoria atualizada com sucesso!', classes: 'rounded'});
        M.Modal.getInstance(document.getElementById('modal-categoria')).close();
        await carregarCategorias(); // Recarrega a lista de categorias
    } catch (error) {
        console.error('Erro ao salvar categoria:', error);
        M.toast({html: 'Erro ao salvar categoria', classes: 'rounded red'});
    }
}
// Função para atualizar uma categoria no IndexedDB
async function atualizarCategoria(categoria) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['categorias'], 'readwrite');
        const store = transaction.objectStore('categorias');
        const request = store.put(categoria);

        request.onerror = function(event) {
            reject("Erro ao atualizar categoria: " + event.target.error);
        };

        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}

// Adicione esta função à inicialização
document.addEventListener('DOMContentLoaded', function() {
    // ... (código existente)
    
    // Inicializa o modal de categoria
    var modalCategoria = document.getElementById('modal-categoria');
    M.Modal.init(modalCategoria);
});

// Função para calcular o orçamento a partir do formulário
async function calcularOrcamento() {
    const clienteId = parseInt(document.getElementById('cliente').value);
    const categoriaId = parseInt(document.getElementById('categoria').value);
    const veiculo = getSelectedVehicle();
    const partesSelecionadas = M.FormSelect.getInstance(document.getElementById('partesCarro')).getSelectedValues();
    const observacoes = document.getElementById('observacoes').value || '';

    if (!clienteId || !categoriaId || !veiculo) {
        M.toast({html: 'Por favor, preencha todos os campos obrigatórios.', classes: 'rounded red'});
        return;
    }

    try {
        const cliente = await buscarClientePorId(clienteId);
        const categoria = await buscarCategoriaPorId(categoriaId);

        if (!cliente || !categoria) {
            throw new Error('Cliente ou categoria não encontrada');
        }

        const valorTotal = await calcularPrecoTotal(categoriaId, partesSelecionadas);

        const novoOrcamento = {
            clienteId,
            categoriaId,
            veiculo,
            partes: partesSelecionadas,
            valor: valorTotal,
            observacoes,
            status: 'Pendente',
            data: new Date()
        };

        const id = await adicionarOrcamento(novoOrcamento);
        M.toast({html: 'Orçamento calculado e salvo com sucesso!', classes: 'rounded'});

        // Limpa o formulário e atualiza os dados
        document.getElementById('orcamentoForm').reset();
        M.FormSelect.init(document.querySelectorAll('select'));
        await carregarOrcamentos();
        await atualizarDashboard();

        // Exibe o resultado do orçamento
        exibirResultadoOrcamento(id, cliente, categoria, novoOrcamento);

        // Navega para o Dashboard
        const tabsInstance = M.Tabs.getInstance(document.querySelector('.tabs'));
        if (tabsInstance) {
            tabsInstance.select('dashboard');
        }

    } catch (error) {
        console.error('Erro ao calcular orçamento:', error);
        M.toast({html: 'Erro ao calcular orçamento: ' + error.message, classes: 'rounded red'});
    }
}

// Função para exibir o resultado do orçamento em um modal
function exibirResultadoOrcamento(id, cliente, categoria, orcamento) {
    const resultado = `
        <h5>Orçamento #${id}</h5>
        <p><strong>Cliente:</strong> ${cliente.nome}</p>
        <p><strong>Veículo:</strong> ${orcamento.veiculo}</p>
        <p><strong>Categoria:</strong> ${categoria.nome}</p>
        <p><strong>Partes:</strong> ${orcamento.partes.join(', ') || 'Nenhuma'}</p>
        <p><strong>Valor Total:</strong> R$ ${orcamento.valor.toFixed(2)}</p>
        <p><strong>Observações:</strong> ${orcamento.observacoes || 'Nenhuma'}</p>
        <p><strong>Status:</strong> ${orcamento.status}</p>
    `;

    const modalContent = document.getElementById('resultado-orcamento-content');
    modalContent.innerHTML = resultado;

    const modalResultado = M.Modal.getInstance(document.getElementById('modal-resultado-orcamento'));
    modalResultado.open();
}

// Função para obter o veículo selecionado (marca, modelo e ano)
function getSelectedVehicle() {
    const marcaSelect = document.getElementById('marca');
    const modeloSelect = document.getElementById('modelo');
    const anoSelect = document.getElementById('ano');

    const marca = marcaSelect.options[marcaSelect.selectedIndex]?.text || '';
    const modelo = modeloSelect.options[modeloSelect.selectedIndex]?.text || '';
    const ano = anoSelect.options[anoSelect.selectedIndex]?.text || '';

    return `${marca} ${modelo} ${ano}`.trim();
}

// Função para compartilhar um orçamento via WhatsApp
async function compartilharViaWhatsApp(orcamentoId) {
    try {
        const orcamento = await buscarOrcamentoPorId(orcamentoId);
        if (!orcamento) throw new Error('Orçamento não encontrado');

        const cliente = await buscarClientePorId(orcamento.clienteId);
        if (!cliente) throw new Error('Cliente não encontrado');

        const categoria = await buscarCategoriaPorId(orcamento.categoriaId);
        if (!categoria) throw new Error('Categoria não encontrada');

        // Formata o número de telefone para o padrão do WhatsApp
        let numeroWhatsApp = cliente.telefone.replace(/\D/g, '');
        numeroWhatsApp = numeroWhatsApp.startsWith('55') ? numeroWhatsApp : '55' + numeroWhatsApp;

        // Monta a mensagem do WhatsApp
        let mensagem = `Olá ${cliente.nome}! Aqui está o orçamento #${orcamentoId} da AUTO-CAR Pro.\n\n`;
        mensagem += `Detalhes do orçamento:\n`;
        mensagem += `- Veículo: ${orcamento.veiculo}\n`;
        mensagem += `- Categoria: ${categoria.nome}\n`;
        mensagem += `- Valor: R$ ${orcamento.valor.toFixed(2)}\n\n`;
        mensagem += `Por favor, entre em contato para mais informações.`;

        const mensagemCodificada = encodeURIComponent(mensagem);
        const urlWhatsApp = `https://api.whatsapp.com/send?phone=${numeroWhatsApp}&text=${mensagemCodificada}`;

        // Abre o WhatsApp em uma nova aba
        window.open(urlWhatsApp, '_blank');

    } catch (error) {
        console.error('Erro ao compartilhar orçamento:', error);
        M.toast({html: `Erro ao compartilhar orçamento: ${error.message}`, classes: 'rounded red'});
    }
}

// Função auxiliar para obter a cor correspondente ao status do orçamento
function getStatusColor(status) {
    switch (status.toLowerCase()) {
        case 'aprovado':
            return 'green';
        case 'pendente':
            return 'yellow darken-2';
        case 'cancelado':
            return 'red';
        default:
            return 'grey';
    }
}

// Função para atualizar os dados do dashboard
async function atualizarDashboard() {
    try {
        const totalOrcamentos = await contarOrcamentos();
        const totalClientes = await contarClientes();
        const totalCategorias = await contarCategorias();
        const faturamentoTotal = await calcularFaturamentoTotal();

        document.getElementById('total-orcamentos').textContent = totalOrcamentos;
        document.getElementById('total-clientes').textContent = totalClientes;
        document.getElementById('total-categorias').textContent = totalCategorias;
        document.getElementById('total-faturamento').textContent = `R$ ${faturamentoTotal.toFixed(2)}`;
    } catch (error) {
        console.error('Erro ao atualizar dashboard:', error);
        M.toast({html: 'Erro ao atualizar dashboard. Por favor, recarregue a página.', classes: 'rounded red'});
    }
}

// Função para contar o total de orçamentos
async function contarOrcamentos() {
    const orcamentos = await buscarTodosOrcamentos();
    return orcamentos.length;
}

// Função para contar o total de clientes
async function contarClientes() {
    const clientes = await buscarTodosClientes();
    return clientes.length;
}

// Função para contar o total de categorias
async function contarCategorias() {
    const categorias = await buscarTodasCategorias();
    return categorias.length;
}

// Função para calcular o faturamento total
async function calcularFaturamentoTotal() {
    const orcamentos = await buscarTodosOrcamentos();
    return orcamentos.reduce((total, orcamento) => total + orcamento.valor, 0);
}

// Função para carregar a lista de orçamentos na interface
async function carregarOrcamentos() {
    try {
        const orcamentos = await buscarTodosOrcamentos();
        const tabelaOrcamentos = document.getElementById('orcamentos-recentes');

        tabelaOrcamentos.innerHTML = '';

        for (const orcamento of orcamentos) {
            const cliente = await buscarClientePorId(orcamento.clienteId);
            const categoria = await buscarCategoriaPorId(orcamento.categoriaId);

            tabelaOrcamentos.innerHTML += `
                <tr>
                    <td>${cliente.nome}</td>
                    <td>${orcamento.veiculo}</td>
                    <td>${categoria.nome}</td>
                    <td>R$ ${orcamento.valor.toFixed(2)}</td>
                    <td><span class="new badge ${getStatusColor(orcamento.status)}" data-badge-caption="${orcamento.status}"></span></td>
                    <td>
                        <a href="#!" class="btn-floating btn-small waves-effect waves-light compartilhar-orcamento" style="background-color: #25D366;" data-orcamento-id="${orcamento.id}">
                            <i class="fab fa-whatsapp" style="font-size: 1.2rem;"></i>
                        </a>
                        <a href="#!" class="btn-floating btn-small waves-effect waves-light gerar-pdf-orcamento" style="background-color: #DB4437;" data-orcamento-id="${orcamento.id}">
                            <i class="fas fa-file-pdf" style="font-size: 1.2rem;"></i>
                        </a>
                    </td>
                </tr>
            `;
        }

        // Adiciona event listeners para os botões de compartilhamento via WhatsApp e geração de PDF
        document.querySelectorAll('.compartilhar-orcamento').forEach(botao => {
            botao.addEventListener('click', function(e) {
                e.preventDefault();
                const orcamentoId = this.getAttribute('data-orcamento-id');
                compartilharViaWhatsApp(orcamentoId);
            });
        });

        document.querySelectorAll('.gerar-pdf-orcamento').forEach(botao => {
            botao.addEventListener('click', function(e) {
                e.preventDefault();
                const orcamentoId = this.getAttribute('data-orcamento-id');
                gerarPDFOrcamento(orcamentoId);
            });
        });

    } catch (error) {
        console.error('Erro ao carregar orçamentos:', error);
        M.toast({html: 'Erro ao carregar orçamentos. Por favor, recarregue a página.', classes: 'rounded red'});
    }
}

// Função para inicializar todos os componentes do Materialize CSS
function initializeAllComponents() {
    M.AutoInit();

    // Inicializa componentes específicos
    var elemsSidenav = document.querySelectorAll('.sidenav');
    M.Sidenav.init(elemsSidenav);

    var elemsTabs = document.querySelectorAll('.tabs');
    M.Tabs.init(elemsTabs, {
        swipeable: false,
        onShow: function(tab) {
            showSection(tab.id);
        }
    });

    var elemsCollapsible = document.querySelectorAll('.collapsible');
    M.Collapsible.init(elemsCollapsible);

    var elemsDropdown = document.querySelectorAll('.dropdown-trigger');
    M.Dropdown.init(elemsDropdown, {
        constrainWidth: false,
        coverTrigger: false,
        closeOnClick: true, // Alterado para fechar ao clicar
        hover: false,
        alignment: 'right'
    });

    var elemsSelect = document.querySelectorAll('select');
    M.FormSelect.init(elemsSelect);

    var elemsModal = document.querySelectorAll('.modal');
    M.Modal.init(elemsModal);
}

// Função para exibir a seção selecionada e atualizar a navegação ativa
function showSection(sectionId) {
    console.log('Mostrando seção:', sectionId);
    // Esconde todas as seções
    document.querySelectorAll('.section').forEach(function(section) {
        section.style.display = 'none';
    });

    // Mostra a seção selecionada
    var targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.style.display = 'block';
    } else {
        console.error('Seção não encontrada:', sectionId);
    }

    // Atualiza a navegação ativa
    updateActiveNavigation(sectionId);
}

// Função para atualizar a navegação ativa nas abas e no sidenav
function updateActiveNavigation(sectionId) {
    document.querySelectorAll('.sidenav a, .tabs a').forEach(function(el) {
        el.classList.remove('active');
    });

    document.querySelectorAll(`.sidenav a[href="#${sectionId}"], .tabs a[href="#${sectionId}"]`).forEach(function(el) {
        el.classList.add('active');
    });
}

// Função para formatar números de telefone
function formatarTelefone(input) {
    let telefone = input.value.replace(/\D/g, '');
    telefone = telefone.replace(/^(\d{2})(\d)/g, '($1) $2');
    telefone = telefone.replace(/(\d)(\d{4})$/, '$1-$2');
    input.value = telefone;
}

// Função para formatar o CNPJ
function formatarCNPJ(input) {
    let cnpj = input.value.replace(/\D/g, '');
    cnpj = cnpj.replace(/^(\d{2})(\d)/, '$1.$2');
    cnpj = cnpj.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    cnpj = cnpj.replace(/\.(\d{3})(\d)/, '.$1/$2');
    cnpj = cnpj.replace(/(\d{4})(\d)/, '$1-$2');
    input.value = cnpj;
}

async function gerarPDFOrcamento(orcamentoId) {
    try {
        const orcamento = await buscarOrcamentoPorId(orcamentoId);
        if (!orcamento) throw new Error('Orçamento não encontrado');

        const cliente = await buscarClientePorId(orcamento.clienteId);
        if (!cliente) throw new Error('Cliente não encontrado');

        const categoria = await buscarCategoriaPorId(orcamento.categoriaId);
        if (!categoria) throw new Error('Categoria não encontrada');

        const dadosEmpresa = await buscarDadosEmpresa();
        if (!dadosEmpresa) throw new Error('Dados da empresa não encontrados');

        // Aqui você pode usar uma biblioteca como jsPDF para gerar o PDF
        // Por exemplo:
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text('Orçamento', 105, 20, null, null, 'center');

        doc.setFontSize(12);
        doc.text(`Orçamento #${orcamentoId}`, 20, 40);
        doc.text(`Data: ${new Date(orcamento.data).toLocaleDateString()}`, 20, 50);
        doc.text(`Cliente: ${cliente.nome}`, 20, 60);
        doc.text(`Veículo: ${orcamento.veiculo}`, 20, 70);
        doc.text(`Categoria: ${categoria.nome}`, 20, 80);
        doc.text(`Valor: R$ ${orcamento.valor.toFixed(2)}`, 20, 90);
        doc.text(`Status: ${orcamento.status}`, 20, 100);

        doc.setFontSize(10);
        doc.text(`${dadosEmpresa.nome} - CNPJ: ${dadosEmpresa.cnpj}`, 20, 120);
        doc.text(`${dadosEmpresa.endereco}`, 20, 130);
        doc.text(`Tel: ${dadosEmpresa.telefone} - Email: ${dadosEmpresa.email}`, 20, 140);

        // Salva o PDF
        doc.save(`orcamento_${orcamentoId}.pdf`);

    } catch (error) {
        console.error('Erro ao gerar PDF do orçamento:', error);
        M.toast({html: `Erro ao gerar PDF do orçamento: ${error.message}`, classes: 'rounded red'});
    }
}




// Função para carregar todos os dados iniciais
async function carregarDados() {
    await carregarClientes();
    await carregarCategorias();
    await carregarOrcamentos();
    atualizarDashboard();
}

// Evento que executa quando o documento está totalmente carregado
document.addEventListener('DOMContentLoaded', function() {
    initializeAllComponents();
    carregarDados();
    loadBrands(); // Carrega as marcas da API FIPE

    // Adiciona event listeners adicionais
    document.getElementById('calcularOrcamentoBtn').addEventListener('click', calcularOrcamento);

    // Adiciona event listeners para navegação
    document.querySelectorAll('.sidenav a[href^="#"]:not([href="#"]), .tabs a[href^="#"]:not([href="#"])').forEach(function(el) {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            var targetId = this.getAttribute('href').substring(1);
            showSection(targetId);
        });
    });

    // Formata inputs de telefone e CNPJ
    document.getElementById('telefone_empresa').addEventListener('input', function() {
        formatarTelefone(this);
    });

    document.getElementById('telefone_cliente').addEventListener('input', function() {
        formatarTelefone(this);
    });

    document.getElementById('telefone_cliente_edit').addEventListener('input', function() {
        formatarTelefone(this);
    });

    document.getElementById('cnpj_empresa').addEventListener('input', function() {
        formatarCNPJ(this);
    });

});

</script>
</body>
</html>
