<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Los_PelikoSs - Orçamento Automotivo</title>
    <!-- Importando Materialize CSS e Icons via CDN -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Estilos personalizados -->
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #fafafa;
        }
        .brand-logo {
            font-size: 1.5rem;
        }
        .tabs .tab a {
            color: #26a69a;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tabs .tab a .material-icons {
            margin-right: 8px;
        }
        .tabs .tab a.active {
            background-color: #e0f2f1;
        }
        .tabs .indicator {
            background-color: #26a69a;
        }
        .loading {
            display: none;
        }
        .btn-primary {
            background-color: #26a69a;
        }
        .btn-primary:hover {
            background-color: #2bbbad;
        }
        .summary-card {
            padding: 20px;
        }
        .summary-card h5 {
            margin-bottom: 20px;
        }
        .disabled-tab a {
            pointer-events: none;
            color: rgba(0, 0, 0, 0.26);
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="teal lighten-1">
        <div class="nav-wrapper container">
            <a href="#" class="brand-logo">Los_PelikoSs - Auto-CAR</a>
        </div>
    </nav>

    <!-- Conteúdo principal -->
    <div class="container">
        <!-- Navegação por abas -->
        <div class="row">
            <div class="col s12">
                <ul class="tabs">
                    <li class="tab col s4"><a href="#veiculoScreen"><i class="material-icons">directions_car</i>Veículos</a></li>
                    <li class="tab col s4 disabled-tab"><a href="#servicosScreen"><i class="material-icons">build</i>Serviços</a></li>
                    <li class="tab col s4 disabled-tab"><a href="#orcamentoScreen"><i class="material-icons">attach_money</i>Orçamento</a></li>
                </ul>
            </div>
        </div>

        <!-- Tela de Cadastro da Empresa (mantida oculta para simplificação) -->
        <!-- ... Código do cadastro da empresa ... -->

        <!-- Tela 1: Informações do Veículo -->
        <div id="veiculoScreen" class="col s12">
            <h4>Informações do Veículo</h4>
            <form id="vehicleInfoForm">
                <div class="row">
                    <div class="input-field col s12">
                        <select id="marca" required>
                            <option value="" disabled selected>Selecione a marca</option>
                        </select>
                        <label>Marca</label>
                    </div>
                    <div class="input-field col s12">
                        <select id="modelo" disabled required>
                            <option value="" disabled selected>Selecione o modelo</option>
                        </select>
                        <label>Modelo</label>
                    </div>
                    <div class="input-field col s12">
                        <select id="ano" disabled required>
                            <option value="" disabled selected>Selecione o ano</option>
                        </select>
                        <label>Ano</label>
                    </div>
                    <div class="input-field col s12">
                        <input id="placa" type="text" required>
                        <label for="placa">Placa</label>
                    </div>
                    <div class="input-field col s12">
                        <select id="pelicula" required>
                            <option value="" disabled selected>Selecione o tipo de película</option>
                            <option value="standard">Película Standard</option>
                            <option value="premium">Película Premium</option>
                            <option value="ceramica">Película Cerâmica</option>
                        </select>
                        <label>Película</label>
                    </div>
                    <div class="col s12">
                        <button type="submit" class="btn btn-primary waves-effect waves-light">Próximo</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Tela 2: Seleção de Serviços -->
        <div id="servicosScreen" class="col s12">
            <h4>Seleção de Serviços</h4>
            <form id="servicosForm">
                <div class="row">
                    <h5>Áreas do Veículo</h5>
                    <p>
                        <label>
                            <input type="checkbox" name="servicos" value="para-brisa" />
                            <span>Para-brisa</span>
                        </label>
                    </p>
                    <p>
                        <label>
                            <input type="checkbox" name="servicos" value="vidro-lateral-dianteiro" />
                            <span>Vidro lateral dianteiro</span>
                        </label>
                    </p>
                    <div class="input-field col s12">
                        <p>
                            <label>
                                <input type="checkbox" name="lado-vidro-lateral-dianteiro" value="D" />
                                <span>Direito</span>
                            </label>
                            <label>
                                <input type="checkbox" name="lado-vidro-lateral-dianteiro" value="E" />
                                <span>Esquerdo</span>
                            </label>
                        </p>
                    </div>
                    <!-- Repita o padrão para os demais serviços -->
                    <h5>Serviços Adicionais</h5>
                    <p>
                        <label>
                            <input type="checkbox" name="servicos-adicionais" value="remocao-pelicula" />
                            <span>Remoção de Película Antiga</span>
                        </label>
                    </p>
                    <div class="col s12">
                        <button type="submit" class="btn btn-primary waves-effect waves-light">Calcular Orçamento</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Tela 3: Prévia do Orçamento -->
        <div id="orcamentoScreen" class="col s12">
            <h4>Prévia do Orçamento</h4>
            <div class="card summary-card">
                <div class="card-content">
                    <div id="orcamentoDetalhes"></div>
                </div>
            </div>
            <button class="btn btn-primary waves-effect waves-light" onclick="imprimirOrcamento()">Imprimir Orçamento</button>
        </div>

        <!-- Indicador de carregamento -->
        <div class="loading center-align">
            <div class="preloader-wrapper active">
                <div class="spinner-layer spinner-teal-only">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div><div class="gap-patch">
                        <div class="circle"></div>
                    </div><div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
            <p>Carregando...</p>
        </div>

    </div>

    <!-- Importando jQuery e Materialize JS via CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Materialize JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- Script personalizado -->
    <script>
        $(document).ready(function() {
            // Inicializa componentes do Materialize
            $('select').formSelect();
            $('.tabs').tabs();

            // Variáveis globais
            const BASE_URL = 'https://parallelum.com.br/fipe/api/v1/carros';

            // Elementos do DOM
            const $marcaSelect = $('#marca');
            const $modeloSelect = $('#modelo');
            const $anoSelect = $('#ano');
            const $tabs = $('.tabs');
            const instanceTabs = M.Tabs.getInstance($tabs);
            const $tabServicos = $('a[href="#servicosScreen"]').parent();
            const $tabOrcamento = $('a[href="#orcamentoScreen"]').parent();

            // Função para buscar dados da API FIPE
            async function fetchFipeData(endpoint) {
                $('.loading').show();
                try {
                    const response = await fetch(`${BASE_URL}/${endpoint}`);
                    const data = await response.json();
                    $('.loading').hide();
                    return data;
                } catch (error) {
                    console.error('Erro ao buscar dados:', error);
                    $('.loading').hide();
                    return [];
                }
            }

            // Carregar marcas de veículos
            async function loadBrands() {
                const brands = await fetchFipeData('marcas');
                brands.forEach(brand => {
                    $marcaSelect.append(`<option value="${brand.codigo}">${brand.nome}</option>`);
                });
                $('select').formSelect();
            }

            // Evento de mudança na seleção da marca
            $marcaSelect.on('change', async function() {
                $modeloSelect.empty().append('<option value="" disabled selected>Selecione o modelo</option>');
                $anoSelect.empty().append('<option value="" disabled selected>Selecione o ano</option>').prop('disabled', true);
                $('select').formSelect();

                const marcaId = $(this).val();
                if (marcaId) {
                    $modeloSelect.prop('disabled', false);
                    const models = await fetchFipeData(`marcas/${marcaId}/modelos`);
                    models.modelos.forEach(model => {
                        $modeloSelect.append(`<option value="${model.codigo}">${model.nome}</option>`);
                    });
                    $('select').formSelect();
                } else {
                    $modeloSelect.prop('disabled', true);
                    $('select').formSelect();
                }
            });

            // Evento de mudança na seleção do modelo
            $modeloSelect.on('change', async function() {
                $anoSelect.empty().append('<option value="" disabled selected>Selecione o ano</option>');
                $('select').formSelect();

                const modeloId = $(this).val();
                const marcaId = $marcaSelect.val();
                if (modeloId) {
                    $anoSelect.prop('disabled', false);
                    const years = await fetchFipeData(`marcas/${marcaId}/modelos/${modeloId}/anos`);
                    years.forEach(year => {
                        $anoSelect.append(`<option value="${year.codigo}">${year.nome}</option>`);
                    });
                    $('select').formSelect();
                } else {
                    $anoSelect.prop('disabled', true);
                    $('select').formSelect();
                }
            });

            // Função para verificar dados do veículo
            function verificarDadosVeiculo() {
                return $('#marca').val() && $('#modelo').val() && $('#ano').val() && $('#placa').val() && $('#pelicula').val();
            }

            // Função para verificar seleção de serviços
            function verificarServicosSelecionados() {
                return $('input[name="servicos"]:checked').length > 0;
            }

            // Event listener para o formulário de informações do veículo
            $('#vehicleInfoForm').on('submit', function(event) {
                event.preventDefault();
                if (!verificarDadosVeiculo()) {
                    M.toast({html: 'Por favor, preencha todos os dados do veículo antes de prosseguir.'});
                    return;
                }
                // Ativar a aba de serviços e permitir a navegação
                $tabServicos.removeClass('disabled-tab');
                instanceTabs.updateTabIndicator();
                instanceTabs.select('servicosScreen');
            });

            // Event listener para o formulário de serviços
            $('#servicosForm').on('submit', function(event) {
                event.preventDefault();
                if (!verificarServicosSelecionados()) {
                    M.toast({html: 'Por favor, selecione pelo menos um serviço antes de prosseguir.'});
                    return;
                }
                calcularOrcamento();
                // Ativar a aba de orçamento e permitir a navegação
                $tabOrcamento.removeClass('disabled-tab');
                instanceTabs.updateTabIndicator();
                instanceTabs.select('orcamentoScreen');
            });

            // Função para calcular o orçamento
            function calcularOrcamento() {
                const servicosSelecionados = $('input[name="servicos"]:checked').map(function() {
                    const servico = $(this).val();
                    const lados = $(`input[name="lado-${servico}"]:checked`).map(function() {
                        return $(this).val();
                    }).get();
                    return { servico, lados };
                }).get();

                const servicosAdicionais = $('input[name="servicos-adicionais"]:checked').map(function() {
                    return $(this).val();
                }).get();

                preencherPreviewOrcamento(servicosSelecionados, servicosAdicionais);
            }

            // Função para preencher a prévia do orçamento
            function preencherPreviewOrcamento(servicos, adicionais) {
                const marca = $('#marca option:selected').text();
                const modelo = $('#modelo option:selected').text();
                const ano = $('#ano option:selected').text();
                const placa = $('#placa').val();
                const pelicula = $('#pelicula option:selected').text();

                let html = `
                    <h5>Detalhes do Veículo</h5>
                    <p><strong>Marca:</strong> ${marca}</p>
                    <p><strong>Modelo:</strong> ${modelo}</p>
                    <p><strong>Ano:</strong> ${ano}</p>
                    <p><strong>Placa:</strong> ${placa}</p>
                    <p><strong>Película:</strong> ${pelicula}</p>

                    <h5>Serviços Selecionados</h5>
                    <ul class="collection">
                `;

                servicos.forEach(servico => {
                    html += `<li class="collection-item">${servico.servico} ${servico.lados.length > 0 ? '(' + servico.lados.join(', ') + ')' : ''}</li>`;
                });

                html += `</ul>`;

                if (adicionais.length > 0) {
                    html += `
                        <h5>Serviços Adicionais</h5>
                        <ul class="collection">
                            ${adicionais.map(adicional => `<li class="collection-item">${adicional}</li>`).join('')}
                        </ul>
                    `;
                }

                // Aqui você pode adicionar o cálculo do preço total
                html += `<h5>Preço Total: <strong>R$ XX,XX</strong></h5>`;

                $('#orcamentoDetalhes').html(html);
            }

            // Função para imprimir o orçamento
            function imprimirOrcamento() {
                window.print();
            }

            // Inicialização
            loadBrands();

            // Desabilitar abas de Serviços e Orçamento no início
            $tabServicos.addClass('disabled-tab');
            $tabOrcamento.addClass('disabled-tab');
        });
    </script>
</body>
</html>
