<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTO-CAR Pro - Or√ßamentos Automotivos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        .brand-logo {
            font-weight: 300;
            font-size: 1.8rem;
        }
        nav {
            box-shadow: none;
        }
        .nav-wrapper {
            padding-left: 20px;
            padding-right: 20px;
        }
        .sidenav {
            width: 300px;
        }
        .sidenav li > a {
            font-weight: 400;
        }
        .sidenav .user-view {
            padding: 32px 32px 0;
        }
        .page-footer {
            padding-top: 0;
        }
        .tabs .tab a {
            color: #26a69a;
        }
        .tabs .tab a:hover, .tabs .tab a.active {
            color: #00796b;
        }
        .tabs .indicator {
            background-color: #00796b;
        }
        .card {
            border-radius: 8px;
        }
        .card-title {
            font-weight: 400;
        }
        .btn-large {
            border-radius: 24px;
        }
        .collection {
            border-radius: 8px;
        }
        .collection .collection-item {
            border-bottom: 1px solid #e0e0e0;
        }
        .collection .collection-item:last-child {
            border-bottom: none;
        }
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        .responsive-table {
            min-width: 800px;
            width: 100%;
        }
        @media only screen and (max-width: 600px) {
            .table-container {
                margin-left: -20px;
                margin-right: -20px;
                padding-left: 20px;
                padding-right: 20px;
            }
        }
          /* Novo estilo para garantir que o dropdown fique acima das tabs */
  /* Novo estilo para o dropdown */
  .dropdown-content {
        z-index: 9999 !important;
        opacity: 1 !important;
        position: fixed !important;
        top: 64px !important; /* Ajuste conforme a altura da sua navbar */
        right: 10px !important;
        left: auto !important;
        width: auto !important;
        max-width: 300px !important;
    }

    /* Garantir que outros elementos permane√ßam vis√≠veis */
    .tabs, .container {
        z-index: 1;
        position: relative;
    }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav>
        <div class="nav-wrapper teal darken-2">
            <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>
            <a href="#" class="brand-logo center">AUTO-CAR Pro</a>
            <ul class="right hide-on-med-and-down">
                <li><a class="dropdown-trigger" href="#!" data-target="dropdown-config"><i class="material-icons">settings</i></a></li>
            </ul>
        </div>
    </nav>
    
<!-- Dropdown Structure -->
<ul id="dropdown-config" class="dropdown-content config-dropdown">
    <li><a href="#!" class="modal-link" onclick="abrirModalDadosEmpresa()"><i class="material-icons">business</i>Perfil da Empresa</a></li>
    <li><a href="#!" class="modal-link" onclick="abrirModalFormasPagamento()"><i class="material-icons">payment</i>Formas de Pagamento</a></li>
</ul>


    <!-- Sidenav -->
    <ul id="slide-out" class="sidenav">
        <li>
            <div class="user-view">
                <div class="background teal darken-2"></div>
                <a href="#perfil"><img class="circle" src="/api/placeholder/100/100" alt="User Profile"></a>
                <a href="#perfil"><span class="white-text name">John Doe</span></a>
                <a href="#perfil"><span class="white-text email">johndoe@example.com</span></a>
            </div>
        </li>
        <li><a href="#dashboard"><i class="material-icons">dashboard</i>Dashboard</a></li>
        <li><a href="#clientes"><i class="material-icons">people</i>Clientes</a></li>
        <li><a href="#orcamentos"><i class="material-icons">description</i>Or√ßamentos</a></li>
        <li><a href="#servicos"><i class="material-icons">build</i>Servi√ßos</a></li>
        <li>
            <ul class="collapsible">
                <li>
                    <div class="collapsible-header"><i class="material-icons">settings</i>Configura√ß√µes</div>
                    <div class="collapsible-body">
                        <ul>
                            <li><a href="#!" class="modal-link" onclick="abrirModalDadosEmpresa()"><i class="material-icons">business</i>Perfil da Empresa</a></li>
                            <li><a href="#!" class="modal-link" onclick="abrirModalFormasPagamento()"><i class="material-icons">payment</i>Formas de Pagamento</a></li>
                        </ul>
                    </div>
                </li>
            </ul>
        </li>
    </ul>
    <!-- Conte√∫do principal -->
    <div class="container">
        <div class="section">
            <div class="row">
                <div class="col s12">
                    <ul class="tabs">
                        <li class="tab col s3 active"><a href="#dashboard">Dashboard</a></li>
                        <li class="tab col s3"><a href="#novo-orcamento">Novo Or√ßamento</a></li>
                        <li class="tab col s3"><a href="#clientes">Clientes</a></li>
                        <li class="tab col s3"><a href="#servicos">Servi√ßos</a></li>
                    </ul>
                    
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section">
            <h4 class="center-align">Dashboard</h4>
            <div class="row">
                <div class="col s12 m6 l3">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Or√ßamentos</span>
                            <h4 class="center-align" id="total-orcamentos">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col s12 m6 l3">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Clientes</span>
                            <h4 class="center-align" id="total-clientes">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col s12 m6 l3">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Servi√ßos</span>
                            <h4 class="center-align" id="total-servicos">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col s12 m6 l3">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Faturamento</span>
                            <h4 class="center-align" id="total-faturamento">R$ 0,00</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">Or√ßamentos Recentes</span>
                            <div class="table-container">
                                <table class="striped responsive-table">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Ve√≠culo</th>
                                            <th>Servi√ßo</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>Compartilhar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orcamentos-recentes">
                                        <!-- Ser√° preenchido dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Novo Or√ßamento -->
        <div id="novo-orcamento" class="section">
            <h4 class="center-align">Novo Or√ßamento</h4>
            <div class="row">
                <form id="orcamentoForm" class="col s12">
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <select id="cliente" required>
                                <option value="" disabled selected>Selecione o cliente</option>
                            </select>
                            <label>Cliente</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <select id="marca" required>
                                <option value="" disabled selected>Selecione a marca</option>
                            </select>
                            <label>Marca do Ve√≠culo</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <select id="modelo" disabled required>
                                <option value="" disabled selected>Selecione o modelo</option>
                            </select>
                            <label>Modelo do Ve√≠culo</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <select id="ano" disabled required>
                                <option value="" disabled selected>Selecione o ano</option>
                            </select>
                            <label>Ano do Ve√≠culo</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <select id="servico" required>
                                <option value="" disabled selected>Selecione o servi√ßo</option>
                            </select>
                            <label>Servi√ßo</label>
                        </div>
                        <div class="input-field col s12 m6">
                            <select multiple id="partesCarro">
                                <option value="" disabled>Selecione as partes do carro</option>
                                <option value="para-brisa">Para-brisa</option>
                                <option value="vidros-laterais">Vidros Laterais</option>
                                <option value="vidro-traseiro">Vidro Traseiro</option>
                                <option value="farol">Far√≥is</option>
                                <option value="lanterna">Lanternas</option>
                            </select>
                            <label>Partes do Carro</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <textarea id="observacoes" class="materialize-textarea"></textarea>
                            <label for="observacoes">Observa√ß√µes</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 center-align">
                            <button type="button" id="calcularOrcamentoBtn" class="btn-large waves-effect waves-light teal darken-2">Calcular Or√ßamento</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Clientes -->
        <div id="clientes" class="section">
            <h4 class="center-align">Clientes</h4>
            <div class="row">
                <div class="col s12">
                    <ul class="collection" id="lista-clientes">
                        <!-- Ser√° preenchido dinamicamente -->
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col s12 center-align">
                    <a class="btn-large waves-effect waves-light teal darken-2 modal-trigger" href="#modal-novo-cliente">
                        <i class="material-icons left">add</i>Novo Cliente
                    </a>
                </div>
            </div>
        </div>

        <!-- Servi√ßos -->
        <div id="servicos" class="section">
            <h4 class="center-align">Servi√ßos</h4>
            <div class="row" id="lista-servicos">
                <!-- Ser√° preenchido dinamicamente -->
            </div>
            <div class="row">
                <div class="col s12 center-align">
                    <a class="btn-large waves-effect waves-light teal darken-2 modal-trigger" href="#modal-novo-servico">
                        <i class="material-icons left">add</i>Novo Servi√ßo
                    </a>
                </div>
            </div>
        </div>
    </div>

<!-- Modal Dados da Empresa -->
<div id="modal-dados-empresa" class="modal">
    <div class="modal-content">
        <h4>Dados da Empresa</h4>
        <form id="formDadosEmpresa">
            <div class="row">
                <div class="input-field col s12">
                    <input id="nome_empresa" type="text" class="validate" required>
                    <label for="nome_empresa">Nome da Empresa</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="cnpj_empresa" type="text" class="validate" required>
                    <label for="cnpj_empresa">CNPJ</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="endereco_empresa" type="text" class="validate" required>
                    <label for="endereco_empresa">Endere√ßo</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s6">
                    <input id="telefone_empresa" type="tel" class="validate" required>
                    <label for="telefone_empresa">Telefone</label>
                </div>
                <div class="input-field col s6">
                    <input id="email_empresa" type="email" class="validate" required>
                    <label for="email_empresa">E-mail</label>
                </div>
            </div>
            <div class="row">
                <div class="file-field input-field">
                    <div class="btn">
                        <span>Logo</span>
                        <input type="file" id="logo_empresa" accept="image/*">
                    </div>
                    <div class="file-path-wrapper">
                        <input class="file-path validate" type="text">
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
        <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="salvarDadosEmpresa()">Salvar</a>
    </div>
</div>

<!-- Modal Formas de Pagamento -->
<div id="modal-formas-pagamento" class="modal">
    <div class="modal-content">
        <h4>Formas de Pagamento</h4>
        <form id="formFormasPagamento">
            <div class="row">
                <div class="input-field col s12">
                    <input id="chave_pix" type="text" class="validate">
                    <label for="chave_pix">Chave PIX</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <select multiple id="prazos_boleto">
                        <option value="15">15 dias</option>
                        <option value="30">30 dias</option>
                        <option value="45">45 dias</option>
                        <option value="60">60 dias</option>
                        <option value="90">90 dias</option>
                    </select>
                    <label>Prazos de Boleto</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s6">
                    <input id="parcelas_sem_juros" type="number" class="validate" min="1">
                    <label for="parcelas_sem_juros">Parcelas sem Juros</label>
                </div>
                <div class="input-field col s6">
                    <input id="parcelas_com_juros" type="number" class="validate" min="1">
                    <label for="parcelas_com_juros">Parcelas com Juros</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="taxa_juros" type="number" step="0.1" class="validate" min="0">
                    <label for="taxa_juros">Taxa de Juros (%)</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
        <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="salvarFormasPagamento()">Salvar</a>
    </div>
</div>

<!-- Modal Novo Cliente -->
<div id="modal-novo-cliente" class="modal">
    <div class="modal-content">
        <h4>Novo Cliente</h4>
        <form id="formNovoCliente">
            <div class="row">
                <div class="input-field col s12">
                    <input id="nome_cliente" type="text" class="validate" required>
                    <label for="nome_cliente">Nome Completo</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12 m6">
                    <input id="email_cliente" type="email" class="validate" required>
                    <label for="email_cliente">E-mail</label>
                </div>
                <div class="input-field col s12 m6">
                    <input id="telefone_cliente" type="tel" class="validate" required>
                    <label for="telefone_cliente">Telefone</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
        <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="salvarNovoCliente()">Salvar</a>
    </div>
</div>

<!-- Modal Novo Servi√ßo -->
<div id="modal-novo-servico" class="modal">
    <div class="modal-content">
        <h4>Novo Servi√ßo</h4>
        <form id="formNovoServico">
            <div class="row">
                <div class="input-field col s12">
                    <input id="nome_servico" type="text" class="validate" required>
                    <label for="nome_servico">Nome do Servi√ßo</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="descricao_servico" class="materialize-textarea"></textarea>
                    <label for="descricao_servico">Descri√ß√£o</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="preco_servico" type="number" step="0.01" class="validate" required>
                    <label for="preco_servico">Pre√ßo (R$)</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
        <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="salvarNovoServico()">Salvar</a>
    </div>
</div>

<!-- Modal Editar Cliente -->
<div id="modal-editar-cliente" class="modal">
    <div class="modal-content">
        <h4>Editar Cliente</h4>
        <form id="formEditarCliente">
            <input type="hidden" id="id_cliente_edit">
            <div class="row">
                <div class="input-field col s12">
                    <input id="nome_cliente_edit" type="text" class="validate" required>
                    <label for="nome_cliente_edit">Nome Completo</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12 m6">
                    <input id="email_cliente_edit" type="email" class="validate" required>
                    <label for="email_cliente_edit">E-mail</label>
                </div>
                <div class="input-field col s12 m6">
                    <input id="telefone_cliente_edit" type="tel" class="validate" required>
                    <label for="telefone_cliente_edit">Telefone</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
        <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="atualizarCliente()">Atualizar</a>
    </div>
</div>

<!-- Modal Editar Servi√ßo -->
<div id="modal-editar-servico" class="modal">
    <div class="modal-content">
        <h4>Editar Servi√ßo</h4>
        <form id="formEditarServico">
            <input type="hidden" id="id_servico_edit">
            <div class="row">
                <div class="input-field col s12">
                    <input id="nome_servico_edit" type="text" class="validate" required>
                    <label for="nome_servico_edit">Nome do Servi√ßo</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="descricao_servico_edit" class="materialize-textarea"></textarea>
                    <label for="descricao_servico_edit">Descri√ß√£o</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <input id="preco_servico_edit" type="number" step="0.01" class="validate" required>
                    <label for="preco_servico_edit">Pre√ßo (R$)</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancelar</a>
        <a href="#!" class="waves-effect waves-green btn teal darken-2" onclick="atualizarServico()">Atualizar</a>
    </div>
</div>

<!-- Modal Resultado Or√ßamento -->
<div id="modal-resultado-orcamento" class="modal">
    <div class="modal-content" id="resultado-orcamento-content">
        <!-- O conte√∫do ser√° preenchido dinamicamente -->
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Fechar</a>
    </div>
</div>

<!-- Footer -->
<footer class="page-footer teal darken-2">
    <div class="footer-copyright">
        <div class="container">
            ¬© 2024 AUTO-CAR Pro
            <a class="grey-text text-lighten-4 right" href="#!">Termos de Uso</a>
        </div>
    </div>
</footer>

<!-- Scripts do Materialize e jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    // Inicializa√ß√£o do IndexedDB
    let db;
    const dbName = 'AutoCarDB';
    const dbVersion = 1;

    const request = indexedDB.open(dbName, dbVersion);

    request.onerror = function(event) {
        console.error("Erro ao abrir o banco de dados:", event.target.error);
    };

    request.onsuccess = function(event) {
        db = event.target.result;
        console.log("Banco de dados aberto com sucesso");
        carregarDados();
    };

    request.onupgradeneeded = function(event) {
        db = event.target.result;
        
        if (!db.objectStoreNames.contains('clientes')) {
            const clientesStore = db.createObjectStore('clientes', { keyPath: 'id', autoIncrement: true });
            clientesStore.createIndex('nome', 'nome', { unique: false });
            clientesStore.createIndex('email', 'email', { unique: true });
        }
        
        if (!db.objectStoreNames.contains('servicos')) {
            const servicosStore = db.createObjectStore('servicos', { keyPath: 'id', autoIncrement: true });
            servicosStore.createIndex('nome', 'nome', { unique: true });
        }
        
        if (!db.objectStoreNames.contains('orcamentos')) {
            const orcamentosStore = db.createObjectStore('orcamentos', { keyPath: 'id', autoIncrement: true });
            orcamentosStore.createIndex('clienteId', 'clienteId', { unique: false });
            orcamentosStore.createIndex('data', 'data', { unique: false });
        }
    
        if (!db.objectStoreNames.contains('configuracoes')) {
            const configuracoesStore = db.createObjectStore('configuracoes', { keyPath: 'id' });
            configuracoesStore.createIndex('nome', 'nome', { unique: false });
        }
    };

    // Fun√ß√£o para converter imagem para Base64
    function converterImagemParaBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    // Fun√ß√µes para buscar e salvar dados no IndexedDB

    async function buscarDadosEmpresa() {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['configuracoes'], 'readonly');
            const store = transaction.objectStore('configuracoes');
            const request = store.get('dadosEmpresa');
            
            request.onerror = function(event) {
                console.error("Erro ao buscar dados da empresa:", event.target.error);
                reject("Erro ao buscar dados da empresa: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    async function buscarFormasPagamento() {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['configuracoes'], 'readonly');
            const store = transaction.objectStore('configuracoes');
            const request = store.get('formasPagamento');
            
            request.onerror = function(event) {
                console.error("Erro ao buscar formas de pagamento:", event.target.error);
                reject("Erro ao buscar formas de pagamento: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    async function salvarDadosEmpresaNoIndexedDB(dadosEmpresa) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['configuracoes'], 'readwrite');
            const store = transaction.objectStore('configuracoes');
            const request = store.put({ id: 'dadosEmpresa', ...dadosEmpresa });
            
            request.onerror = function(event) {
                reject("Erro ao salvar dados da empresa: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    async function salvarFormasPagamentoNoIndexedDB(formasPagamento) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['configuracoes'], 'readwrite');
            const store = transaction.objectStore('configuracoes');
            const request = store.put({ id: 'formasPagamento', ...formasPagamento });
            
            request.onerror = function(event) {
                reject("Erro ao salvar formas de pagamento: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    // Fun√ß√µes para abrir modais e carregar dados
    function abrirModalDadosEmpresa() {
        carregarDadosEmpresa();
        var modal = M.Modal.getInstance(document.getElementById('modal-dados-empresa'));
        modal.open();
    }

    function abrirModalFormasPagamento() {
        carregarFormasPagamento();
        var modal = M.Modal.getInstance(document.getElementById('modal-formas-pagamento'));
        modal.open();
    }

    async function salvarDadosEmpresa() {
        const dadosEmpresa = {
            nome: document.getElementById('nome_empresa').value,
            cnpj: document.getElementById('cnpj_empresa').value,
            endereco: document.getElementById('endereco_empresa').value,
            telefone: document.getElementById('telefone_empresa').value,
            email: document.getElementById('email_empresa').value
        };

        const logoInput = document.getElementById('logo_empresa');
        if (logoInput.files.length > 0) {
            dadosEmpresa.logo = await converterImagemParaBase64(logoInput.files[0]);
        }

        try {
            await salvarDadosEmpresaNoIndexedDB(dadosEmpresa);
            M.toast({html: 'Dados da empresa salvos com sucesso!', classes: 'rounded'});
            M.Modal.getInstance(document.getElementById('modal-dados-empresa')).close();
        } catch (error) {
            M.toast({html: 'Erro ao salvar dados da empresa: ' + error, classes: 'rounded red'});
        }
    }

    async function salvarFormasPagamento() {
        const formasPagamento = {
            chavePix: document.getElementById('chave_pix').value,
            prazosBoleto: M.FormSelect.getInstance(document.getElementById('prazos_boleto')).getSelectedValues(),
            parcelasSemJuros: parseInt(document.getElementById('parcelas_sem_juros').value),
            parcelasComJuros: parseInt(document.getElementById('parcelas_com_juros').value),
            taxaJuros: parseFloat(document.getElementById('taxa_juros').value)
        };

        try {
            await salvarFormasPagamentoNoIndexedDB(formasPagamento);
            M.toast({html: 'Formas de pagamento salvas com sucesso!', classes: 'rounded'});
            M.Modal.getInstance(document.getElementById('modal-formas-pagamento')).close();
        } catch (error) {
            M.toast({html: 'Erro ao salvar formas de pagamento: ' + error, classes: 'rounded red'});
        }
    }

    // Fun√ß√µes auxiliares para salvar no IndexedDB

    // Fun√ß√µes para carregar dados da empresa e formas de pagamento
    async function carregarDadosEmpresa() {
        const dadosEmpresa = await buscarDadosEmpresa();
        if (dadosEmpresa) {
            document.getElementById('nome_empresa').value = dadosEmpresa.nome || '';
            document.getElementById('cnpj_empresa').value = dadosEmpresa.cnpj || '';
            document.getElementById('endereco_empresa').value = dadosEmpresa.endereco || '';
            document.getElementById('telefone_empresa').value = dadosEmpresa.telefone || '';
            document.getElementById('email_empresa').value = dadosEmpresa.email || '';
            if (dadosEmpresa.logo) {
                // Exibir logo, se necess√°rio
            }
            M.updateTextFields();
        }
    }

    async function carregarFormasPagamento() {
        const formasPagamento = await buscarFormasPagamento();
        if (formasPagamento) {
            document.getElementById('chave_pix').value = formasPagamento.chavePix || '';
            M.FormSelect.getInstance(document.getElementById('prazos_boleto')).destroy();
            document.getElementById('prazos_boleto').value = formasPagamento.prazosBoleto || [];
            M.FormSelect.init(document.getElementById('prazos_boleto'));
            document.getElementById('parcelas_sem_juros').value = formasPagamento.parcelasSemJuros || '';
            document.getElementById('parcelas_com_juros').value = formasPagamento.parcelasComJuros || '';
            document.getElementById('taxa_juros').value = formasPagamento.taxaJuros || '';
            M.updateTextFields();
        }
    }

    // Fun√ß√µes de manipula√ß√£o de dados

    async function adicionarCliente(cliente) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['clientes'], 'readwrite');
            const store = transaction.objectStore('clientes');
            const request = store.add(cliente);
            
            request.onerror = function(event) {
                reject("Erro ao adicionar cliente: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    async function adicionarServico(servico) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['servicos'], 'readwrite');
            const store = transaction.objectStore('servicos');
            const request = store.add(servico);
            
            request.onerror = function(event) {
                reject("Erro ao adicionar servi√ßo: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    async function adicionarOrcamento(orcamento) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['orcamentos'], 'readwrite');
            const store = transaction.objectStore('orcamentos');
            const request = store.add(orcamento);
            
            request.onerror = function(event) {
                reject("Erro ao adicionar or√ßamento: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

 // Fun√ß√£o para atualizar cliente no IndexedDB
async function atualizarClienteDB(cliente) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['clientes'], 'readwrite');
        const store = transaction.objectStore('clientes');
        const request = store.put(cliente);
        
        request.onerror = function(event) {
            reject("Erro ao atualizar cliente: " + event.target.error);
        };
        
        request.onsuccess = function(event) {
            resolve(event.target.result);
        };
    });
}


    async function atualizarServico(servico) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['servicos'], 'readwrite');
            const store = transaction.objectStore('servicos');
            const request = store.put(servico);
            
            request.onerror = function(event) {
                reject("Erro ao atualizar servi√ßo: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    async function excluirCliente(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['clientes'], 'readwrite');
            const store = transaction.objectStore('clientes');
            const request = store.delete(id);
            
            request.onerror = function(event) {
                reject("Erro ao excluir cliente: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve();
            };
        });
    }

    async function excluirServico(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['servicos'], 'readwrite');
            const store = transaction.objectStore('servicos');
            const request = store.delete(id);
            
            request.onerror = function(event) {
                reject("Erro ao excluir servi√ßo: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve();
            };
        });
    }

    async function buscarTodosClientes() {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['clientes'], 'readonly');
            const store = transaction.objectStore('clientes');
            const request = store.getAll();
            
            request.onerror = function(event) {
                reject("Erro ao buscar clientes: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    async function buscarTodosServicos() {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['servicos'], 'readonly');
            const store = transaction.objectStore('servicos');
            const request = store.getAll();
            
            request.onerror = function(event) {
                reject("Erro ao buscar servi√ßos: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    async function buscarTodosOrcamentos() {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.getAll();
            
            request.onerror = function(event) {
                reject("Erro ao buscar or√ßamentos: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
        });
    }

    async function buscarClientePorId(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['clientes'], 'readonly');
            const store = transaction.objectStore('clientes');
            const request = store.get(id);
            
            request.onerror = function(event) {
                console.error("Erro ao buscar cliente:", event.target.error);
                reject("Erro ao buscar cliente: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                const cliente = event.target.result;
                console.log("Cliente encontrado:", cliente);
                resolve(cliente);
            };
        });
    }

    async function buscarOrcamentoPorId(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.get(id);
            
            request.onerror = function(event) {
                console.error("Erro ao buscar or√ßamento:", event.target.error);
                reject("Erro ao buscar or√ßamento: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                const orcamento = event.target.result;
                if (orcamento) {
                    resolve(orcamento);
                } else {
                    reject("Or√ßamento n√£o encontrado");
                }
            };
        });
    }

    async function buscarServicoPorId(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['servicos'], 'readonly');
            const store = transaction.objectStore('servicos');
            const request = store.get(id);
            
            request.onerror = function(event) {
                console.error("Erro ao buscar servi√ßo:", event.target.error);
                reject("Erro ao buscar servi√ßo: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                const servico = event.target.result;
                console.log("Servi√ßo encontrado:", servico);
                resolve(servico);
            };
        });
    }

    // Fun√ß√µes de interface do usu√°rio

    async function carregarDados() {
        await carregarClientes();
        await carregarServicos();
        await carregarOrcamentos();
        atualizarDashboard();
    }

    async function carregarClientes() {
        const clientes = await buscarTodosClientes();
        const listaClientes = document.getElementById('lista-clientes');
        const selectCliente = document.getElementById('cliente');
        
        listaClientes.innerHTML = '';
        selectCliente.innerHTML = '<option value="" disabled selected>Selecione o cliente</option>';
        
        clientes.forEach(cliente => {
            listaClientes.innerHTML += `
                <li class="collection-item avatar">
                    <img src="/api/placeholder/100/100" alt="" class="circle">
                    <span class="title">${cliente.nome}</span>
                    <p>${cliente.email}<br>${cliente.telefone}</p>
                    <a href="#!" class="secondary-content" onclick="editarCliente(${cliente.id})"><i class="material-icons">edit</i></a>
                    <a href="#!" class="secondary-content" onclick="confirmarExclusaoCliente(${cliente.id})"><i class="material-icons">delete</i></a>
                </li>
            `;
            
            selectCliente.innerHTML += `<option value="${cliente.id}">${cliente.nome}</option>`;
        });
        
        M.FormSelect.init(selectCliente);
    }

    async function carregarServicos() {
        const servicos = await buscarTodosServicos();
        const listaServicos = document.getElementById('lista-servicos');
        const selectServico = document.getElementById('servico');
        
        listaServicos.innerHTML = '';
        selectServico.innerHTML = '<option value="" disabled selected>Selecione o servi√ßo</option>';
        
        servicos.forEach(servico => {
            listaServicos.innerHTML += `
                <div class="col s12 m6">
                    <div class="card">
                        <div class="card-content">
                            <span class="card-title">${servico.nome}</span>
                            <p>${servico.descricao}</p>
                            <p><strong>Pre√ßo:</strong> R$ ${servico.preco.toFixed(2)}</p>
                        </div>
                        <div class="card-action">
                            <a href="#!" class="teal-text" onclick="editarServico(${servico.id})">Editar</a>
                            <a href="#!" class="red-text" onclick="confirmarExclusaoServico(${servico.id})">Remover</a>
                        </div>
                    </div>
                </div>
            `;
            
            selectServico.innerHTML += `<option value="${servico.id}">${servico.nome}</option>`;
        });
        
        M.FormSelect.init(selectServico);
    }

    async function carregarOrcamentos() {
        const orcamentos = await buscarTodosOrcamentos();
        const tabelaOrcamentos = document.getElementById('orcamentos-recentes');
        
        tabelaOrcamentos.innerHTML = '';
        
        for (const orcamento of orcamentos) {
            const cliente = await buscarClientePorId(orcamento.clienteId);
            const servico = await buscarServicoPorId(orcamento.servicoId);
            
            tabelaOrcamentos.innerHTML += `
                <tr>
                    <td>${cliente.nome}</td>
                    <td>${orcamento.veiculo}</td>
                    <td>${servico.nome}</td>
                    <td>R$ ${orcamento.valor.toFixed(2)}</td>
                    <td><span class="new badge ${getStatusColor(orcamento.status)}" data-badge-caption="${orcamento.status}"></span></td>
                    <td>
                        <a href="#!" onclick="compartilharViaWhatsApp(${orcamento.id})" class="btn-floating btn-small waves-effect waves-light green">
                            <i class="material-icons">share</i>
                        </a>
                    </td>
                </tr>
            `;
        }
    }
             //WHATSAPP
    async function compartilharViaWhatsApp(orcamentoId) {
    try {
        const orcamento = await buscarOrcamentoPorId(orcamentoId);
        const cliente = await buscarClientePorId(orcamento.clienteId);
        const servico = await buscarServicoPorId(orcamento.servicoId);
        const dadosEmpresa = await buscarDadosEmpresa();
        const formasPagamento = await buscarFormasPagamento();

        let mensagem = `Ol√° ${cliente.nome},\n\n`;
        mensagem += `Segue o or√ßamento para o seu ve√≠culo:\n\n`;
        mensagem += `üöó Ve√≠culo: ${orcamento.veiculo}\n`;
        mensagem += `üîß Servi√ßo: ${servico.nome}\n`;
        mensagem += `üìã Partes selecionadas: ${orcamento.partes.join(', ') || 'Nenhuma'}\n`;
        mensagem += `üí∞ Valor total: R$ ${orcamento.valor.toFixed(2)}\n\n`;

        mensagem += `Formas de Pagamento:\n`;
        mensagem += `- PIX: ${formasPagamento.chavePix}\n`;
        mensagem += `- Boleto: ${formasPagamento.prazosBoleto.join(', ')} dias\n`;
        mensagem += `- Cart√£o: at√© ${formasPagamento.parcelasSemJuros}x sem juros ou ${formasPagamento.parcelasComJuros}x com ${formasPagamento.taxaJuros}% de juros\n\n`;

        if (orcamento.observacoes) {
            mensagem += `Observa√ß√µes: ${orcamento.observacoes}\n\n`;
        }

        mensagem += `Atenciosamente,\n${dadosEmpresa.nome}\n`;
        mensagem += `üìû ${dadosEmpresa.telefone}\n`;
        mensagem += `üìß ${dadosEmpresa.email}`;

        const mensagemCodificada = encodeURIComponent(mensagem);
        const numeroWhatsApp = cliente.telefone.replace(/\D/g, '');
        
        // Use 'api.whatsapp.com' para compatibilidade entre desktop e mobile
        const urlWhatsApp = `https://api.whatsapp.com/send?phone=${numeroWhatsApp}&text=${mensagemCodificada}`;

        // Detecta se √© um dispositivo m√≥vel
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        if (isMobile) {
            // Em dispositivos m√≥veis, tenta abrir diretamente o aplicativo do WhatsApp
            window.location.href = urlWhatsApp;
        } else {
            // Em desktops, abre em uma nova aba
            window.open(urlWhatsApp, '_blank');
        }
    } catch (error) {
        console.error('Erro ao compartilhar or√ßamento:', error);
        M.toast({html: 'Erro ao compartilhar or√ßamento. Por favor, tente novamente.', classes: 'rounded red'});
    }
}

    function getStatusColor(status) {
        switch (status.toLowerCase()) {
            case 'aprovado':
                return 'green';
            case 'pendente':
                return 'yellow darken-2';
            case 'cancelado':
                return 'red';
            default:
                return 'grey';
        }
    }

    // Fun√ß√µes para buscar cliente e servi√ßo por ID
    async function buscarClientePorId(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['clientes'], 'readonly');
            const store = transaction.objectStore('clientes');
            const request = store.get(id);
            
            request.onerror = function(event) {
                console.error("Erro ao buscar cliente:", event.target.error);
                reject("Erro ao buscar cliente: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                const cliente = event.target.result;
                console.log("Cliente encontrado:", cliente);
                resolve(cliente);
            };
        });
    }

    async function buscarOrcamentoPorId(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.get(id);
            
            request.onerror = function(event) {
                console.error("Erro ao buscar or√ßamento:", event.target.error);
                reject("Erro ao buscar or√ßamento: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                const orcamento = event.target.result;
                if (orcamento) {
                    resolve(orcamento);
                } else {
                    reject("Or√ßamento n√£o encontrado");
                }
            };
        });
    }

    async function buscarServicoPorId(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['servicos'], 'readonly');
            const store = transaction.objectStore('servicos');
            const request = store.get(id);
            
            request.onerror = function(event) {
                console.error("Erro ao buscar servi√ßo:", event.target.error);
                reject("Erro ao buscar servi√ßo: " + event.target.error);
            };
            
            request.onsuccess = function(event) {
                const servico = event.target.result;
                console.log("Servi√ßo encontrado:", servico);
                resolve(servico);
            };
        });
    }

    // Fun√ß√µes para carregar dados e atualizar o dashboard

    async function atualizarDashboard() {
        const totalOrcamentos = await contarOrcamentos();
        const totalClientes = await contarClientes();
        const totalServicos = await contarServicos();
        const faturamentoTotal = await calcularFaturamentoTotal();

        document.getElementById('total-orcamentos').textContent = totalOrcamentos;
        document.getElementById('total-clientes').textContent = totalClientes;
        document.getElementById('total-servicos').textContent = totalServicos;
        document.getElementById('total-faturamento').textContent = `R$ ${faturamentoTotal.toFixed(2)}`;
    }

    async function contarOrcamentos() {
        const orcamentos = await buscarTodosOrcamentos();
        return orcamentos.length;
    }

    async function contarClientes() {
        const clientes = await buscarTodosClientes();
        return clientes.length;
    }

    async function contarServicos() {
        const servicos = await buscarTodosServicos();
        return servicos.length;
    }

    async function calcularFaturamentoTotal() {
        const orcamentos = await buscarTodosOrcamentos();
        return orcamentos.reduce((total, orcamento) => total + orcamento.valor, 0);
    }

    // Fun√ß√µes para salvar novos clientes e servi√ßos
    async function salvarNovoCliente() {
        const nome = document.getElementById('nome_cliente').value;
        const email = document.getElementById('email_cliente').value;
        const telefone = document.getElementById('telefone_cliente').value;

        try {
            await adicionarCliente({ nome, email, telefone });
            M.toast({html: 'Cliente salvo com sucesso!', classes: 'rounded'});
            document.getElementById('formNovoCliente').reset();
            M.Modal.getInstance(document.getElementById('modal-novo-cliente')).close();
            await carregarClientes();
            atualizarDashboard();
        } catch (error) {
            M.toast({html: 'Erro ao salvar cliente: ' + error, classes: 'rounded red'});
        }
    }

    async function salvarNovoServico() {
        const nome = document.getElementById('nome_servico').value;
        const descricao = document.getElementById('descricao_servico').value;
        const preco = parseFloat(document.getElementById('preco_servico').value);

        try {
            await adicionarServico({ nome, descricao, preco });
            M.toast({html: 'Servi√ßo salvo com sucesso!', classes: 'rounded'});
            document.getElementById('formNovoServico').reset();
            M.Modal.getInstance(document.getElementById('modal-novo-servico')).close();
            await carregarServicos();
            atualizarDashboard();
        } catch (error) {
            M.toast({html: 'Erro ao salvar servi√ßo: ' + error, classes: 'rounded red'});
        }
    }

    // Fun√ß√µes para editar clientes e servi√ßos
    function editarCliente(id) {
        buscarClientePorId(id).then(cliente => {
            document.getElementById('id_cliente_edit').value = cliente.id;
            document.getElementById('nome_cliente_edit').value = cliente.nome;
            document.getElementById('email_cliente_edit').value = cliente.email;
            document.getElementById('telefone_cliente_edit').value = cliente.telefone;
            M.updateTextFields();
            M.Modal.getInstance(document.getElementById('modal-editar-cliente')).open();
        });
    }

    function editarServico(id) {
        buscarServicoPorId(id).then(servico => {
            document.getElementById('id_servico_edit').value = servico.id;
            document.getElementById('nome_servico_edit').value = servico.nome;
            document.getElementById('descricao_servico_edit').value = servico.descricao;
            document.getElementById('preco_servico_edit').value = servico.preco;
            M.updateTextFields();
            M.Modal.getInstance(document.getElementById('modal-editar-servico')).open();
        });
    }

    async function atualizarCliente() {
        const id = parseInt(document.getElementById('id_cliente_edit').value);
        const nome = document.getElementById('nome_cliente_edit').value;
        const email = document.getElementById('email_cliente_edit').value;
        const telefone = document.getElementById('telefone_cliente_edit').value;

        try {
            await atualizarCliente({ id, nome, email, telefone });
            M.toast({html: 'Cliente atualizado com sucesso!', classes: 'rounded'});
            M.Modal.getInstance(document.getElementById('modal-editar-cliente')).close();
            await carregarClientes();
            atualizarDashboard();
        } catch (error) {
            M.toast({html: 'Erro ao atualizar cliente: ' + error, classes: 'rounded red'});
        }
    }

    async function atualizarServico() {
        const id = parseInt(document.getElementById('id_servico_edit').value);
        const nome = document.getElementById('nome_servico_edit').value;
        const descricao = document.getElementById('descricao_servico_edit').value;
        const preco = parseFloat(document.getElementById('preco_servico_edit').value);

        try {
            await atualizarServico({ id, nome, descricao, preco });
            M.toast({html: 'Servi√ßo atualizado com sucesso!', classes: 'rounded'});
            M.Modal.getInstance(document.getElementById('modal-editar-servico')).close();
            await carregarServicos();
            atualizarDashboard();
        } catch (error) {
            M.toast({html: 'Erro ao atualizar servi√ßo: ' + error, classes: 'rounded red'});
        }
    }

    // Fun√ß√µes para confirmar exclus√£o de clientes e servi√ßos
    function confirmarExclusaoCliente(id) {
        if (confirm('Tem certeza que deseja excluir este cliente?')) {
            excluirCliente(id).then(() => {
                M.toast({html: 'Cliente exclu√≠do com sucesso!', classes: 'rounded'});
                carregarClientes();
                atualizarDashboard();
            }).catch(error => {
                M.toast({html: 'Erro ao excluir cliente: ' + error, classes: 'rounded red'});
            });
        }
    }

    function confirmarExclusaoServico(id) {
        if (confirm('Tem certeza que deseja excluir este servi√ßo?')) {
            excluirServico(id).then(() => {
                M.toast({html: 'Servi√ßo exclu√≠do com sucesso!', classes: 'rounded'});
                carregarServicos();
                atualizarDashboard();
            }).catch(error => {
                M.toast({html: 'Erro ao excluir servi√ßo: ' + error, classes: 'rounded red'});
            });
        }
    }

    // Configura√ß√£o e fun√ß√µes para a API FIPE
    const BASE_URL = 'https://parallelum.com.br/fipe/api/v1/carros';

    const $marcaSelect = document.getElementById('marca');
    const $modeloSelect = document.getElementById('modelo');
    const $anoSelect = document.getElementById('ano');

    // Fun√ß√£o para buscar dados da API com cache
    async function fetchFipeData(endpoint) {
        const cacheKey = `fipe_${endpoint}`;
        const cachedData = localStorage.getItem(cacheKey);
        
        if (cachedData) {
            return JSON.parse(cachedData);
        }

        try {
            const url = `${BASE_URL}${endpoint}`;
            console.log('Fazendo requisi√ß√£o para:', url);
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            localStorage.setItem(cacheKey, JSON.stringify(data));
            return data;
        } catch (error) {
            console.error('Erro ao buscar dados da API FIPE:', error);
            throw error;
        }
    }

    // Fun√ß√£o para carregar marcas
    async function loadBrands() {
        $marcaSelect.innerHTML = '<option value="" disabled selected>Selecione a marca</option>';
        try {
            const brands = await fetchFipeData('/marcas');
            if (brands.length > 0) {
                brands.forEach(brand => {
                    $marcaSelect.innerHTML += `<option value="${brand.codigo}">${brand.nome}</option>`;
                });
            } else {
                $marcaSelect.innerHTML += '<option value="" disabled>Nenhuma marca encontrada</option>';
            }
        } catch (error) {
            console.error('Erro ao carregar marcas:', error);
            $marcaSelect.innerHTML += '<option value="" disabled>Erro ao carregar marcas</option>';
        }
        M.FormSelect.init($marcaSelect);
    }

    // Evento ao selecionar uma marca
    $marcaSelect.addEventListener('change', async function() {
        $modeloSelect.innerHTML = '<option value="" disabled selected>Selecione o modelo</option>';
        $anoSelect.innerHTML = '<option value="" disabled selected>Selecione o ano</option>';
        $modeloSelect.disabled = true;
        $anoSelect.disabled = true;
        M.FormSelect.init($modeloSelect);
        M.FormSelect.init($anoSelect);

        const marcaId = this.value;
        console.log('Marca selecionada:', marcaId);
        if (marcaId) {
            $modeloSelect.disabled = false;
            try {
                const modelsData = await fetchFipeData(`/marcas/${marcaId}/modelos`);
                console.log('Dados dos modelos recebidos:', modelsData);
                if (modelsData && modelsData.modelos) {
                    modelsData.modelos.forEach(model => {
                        $modeloSelect.innerHTML += `<option value="${model.codigo}">${model.nome}</option>`;
                    });
                    console.log('Modelos carregados no dropdown');
                } else {
                    console.log('Nenhum modelo encontrado ou estrutura de dados inesperada');
                }
            } catch (error) {
                console.error('Erro ao carregar modelos:', error);
                $modeloSelect.innerHTML += '<option value="" disabled>Erro ao carregar modelos</option>';
            }
            M.FormSelect.init($modeloSelect);
        }
    });

    // Evento ao selecionar um modelo
    $modeloSelect.addEventListener('change', async function() {
        $anoSelect.innerHTML = '<option value="" disabled selected>Selecione o ano</option>';
        $anoSelect.disabled = true;
        M.FormSelect.init($anoSelect);

        const modeloId = this.value;
        const marcaId = $marcaSelect.value;
        if (modeloId) {
            $anoSelect.disabled = false;
            try {
                const years = await fetchFipeData(`/marcas/${marcaId}/modelos/${modeloId}/anos`);
                if (years.length > 0) {
                    years.forEach(year => {
                        $anoSelect.innerHTML += `<option value="${year.codigo}">${year.nome}</option>`;
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar anos:', error);
                $anoSelect.innerHTML += '<option value="" disabled>Erro ao carregar anos</option>';
            }
            M.FormSelect.init($anoSelect);
        }
    });

    // Evento ao selecionar um ano
    $anoSelect.addEventListener('change', async function() {
        const anoId = this.value;
        const modeloId = $modeloSelect.value;
        const marcaId = $marcaSelect.value;
        if (anoId && modeloId && marcaId) {
            try {
                const vehicleData = await fetchFipeData(`/marcas/${marcaId}/modelos/${modeloId}/anos/${anoId}`);
                if (vehicleData) {
                    console.log('Dados do ve√≠culo:', vehicleData);
                    // Aqui voc√™ pode adicionar l√≥gica adicional para usar os dados do ve√≠culo
                }
            } catch (error) {
                console.error('Erro ao buscar dados do ve√≠culo:', error);
            }
        }
    });

    // Fun√ß√£o para obter o ve√≠culo selecionado
    function getSelectedVehicle() {
        const marca = $marcaSelect.options[$marcaSelect.selectedIndex]?.text || '';
        const modelo = $modeloSelect.options[$modeloSelect.selectedIndex]?.text || '';
        const ano = $anoSelect.options[$anoSelect.selectedIndex]?.text || '';

        return `${marca} ${modelo} ${ano}`.trim();
    }

   // Fun√ß√£o para inicializar todos os componentes do Materialize
   function initializeAllComponents() {
    M.AutoInit(); // Inicializa a maioria dos componentes automaticamente

    // Inicializar componentes espec√≠ficos se necess√°rio
    var elemsSidenav = document.querySelectorAll('.sidenav');
    M.Sidenav.init(elemsSidenav);

    var elemsCollapsible = document.querySelectorAll('.collapsible');
    M.Collapsible.init(elemsCollapsible);

    var elemsDropdown = document.querySelectorAll('.dropdown-trigger');
    M.Dropdown.init(elemsDropdown, {
        constrainWidth: false,
        coverTrigger: false,
        closeOnClick: false,
        hover: false,
        alignment: 'right'
    });

    var elemsSelect = document.querySelectorAll('select');
    M.FormSelect.init(elemsSelect);

    var elemsModal = document.querySelectorAll('.modal');
    M.Modal.init(elemsModal);

    var elemsTabs = document.querySelectorAll('.tabs');
    M.Tabs.init(elemsTabs);
}



    // Fun√ß√£o para calcular or√ßamento
    async function calcularOrcamento() {
        console.log('Iniciando c√°lculo de or√ßamento');

        const clienteSelect = document.getElementById('cliente');
        const servicoSelect = document.getElementById('servico');
        const partesCarro = document.getElementById('partesCarro');

        if (!clienteSelect || !servicoSelect || !partesCarro) {
            console.error('Elementos de formul√°rio n√£o encontrados');
            M.toast({html: 'Erro ao carregar formul√°rio. Por favor, recarregue a p√°gina.', classes: 'rounded red'});
            return;
        }

        const clienteId = parseInt(clienteSelect.value);
        const servicoId = parseInt(servicoSelect.value);
        const veiculo = getSelectedVehicle();
        const partesSelecionadas = M.FormSelect.getInstance(partesCarro).getSelectedValues();
        const observacoes = document.getElementById('observacoes')?.value || '';

        console.log('Dados coletados:', { clienteId, servicoId, veiculo, partesSelecionadas, observacoes });

        if (!clienteId || !servicoId || !veiculo) {
            M.toast({html: 'Por favor, preencha todos os campos obrigat√≥rios.', classes: 'rounded red'});
            return;
        }

        try {
            const cliente = await buscarClientePorId(clienteId);
            const servico = await buscarServicoPorId(servicoId);

            console.log('Cliente e servi√ßo buscados:', { cliente, servico });

            if (!cliente || !servico) {
                throw new Error('Cliente ou servi√ßo n√£o encontrado');
            }

            // C√°lculo simplificado do valor do or√ßamento
            const valorBase = servico.preco || 0;
            const valorPartes = partesSelecionadas.length * 50; // 50 reais por parte adicional
            const valorTotal = valorBase + valorPartes;

            console.log('Valores calculados:', { valorBase, valorPartes, valorTotal });

            const novoOrcamento = {
                clienteId,
                servicoId,
                veiculo,
                partes: partesSelecionadas,
                valor: valorTotal,
                observacoes,
                status: 'Pendente',
                data: new Date()
            };

            console.log('Novo or√ßamento criado:', novoOrcamento);

            const id = await adicionarOrcamento(novoOrcamento);
            M.toast({html: 'Or√ßamento calculado e salvo com sucesso!', classes: 'rounded'});

            // Limpar formul√°rio e atualizar dados
            document.getElementById('orcamentoForm').reset();
            M.FormSelect.init(document.querySelectorAll('select'));
            await carregarOrcamentos();
            await atualizarDashboard();

            // Exibir resultado do or√ßamento
            exibirResultadoOrcamento(id, cliente, servico, novoOrcamento);

            // Navegar para o Dashboard
            const tabsInstance = M.Tabs.getInstance(document.querySelector('.tabs'));
            if (tabsInstance) {
                tabsInstance.select('dashboard');
            } else {
                console.error('Inst√¢ncia de tabs n√£o encontrada');
            }

        } catch (error) {
            console.error('Erro ao calcular or√ßamento:', error);
            M.toast({html: 'Erro ao calcular or√ßamento: ' + error.message, classes: 'rounded red'});
        }
    }

    // Fun√ß√£o para exibir o resultado do or√ßamento
    function exibirResultadoOrcamento(id, cliente, servico, orcamento) {
        const resultado = `
            <h5>Or√ßamento #${id}</h5>
            <p><strong>Cliente:</strong> ${cliente.nome}</p>
            <p><strong>Ve√≠culo:</strong> ${orcamento.veiculo}</p>
            <p><strong>Servi√ßo:</strong> ${servico.nome}</p>
            <p><strong>Partes:</strong> ${orcamento.partes.join(', ') || 'Nenhuma'}</p>
            <p><strong>Valor Total:</strong> R$ ${orcamento.valor.toFixed(2)}</p>
            <p><strong>Observa√ß√µes:</strong> ${orcamento.observacoes || 'Nenhuma'}</p>
            <p><strong>Status:</strong> ${orcamento.status}</p>
        `;

        const modalContent = document.getElementById('resultado-orcamento-content');
        modalContent.innerHTML = resultado;

        const modalResultado = M.Modal.getInstance(document.getElementById('modal-resultado-orcamento'));
        modalResultado.open();
    }

    // Fun√ß√µes para compartilhar or√ßamento via WhatsApp (j√° implementada anteriormente)
    // ... [Fun√ß√µes existentes] ...

    // Fun√ß√µes adicionais para melhorar a experi√™ncia do usu√°rio

    // Atualizar selects de forma din√¢mica quando dados s√£o alterados
    async function atualizarSelects() {
        await carregarClientes();
        await carregarServicos();
        M.FormSelect.init(document.querySelectorAll('select'));
    }

    // Atualizar a interface ap√≥s altera√ß√µes nos dados
    async function atualizarInterface() {
        await atualizarSelects();
        await carregarOrcamentos();
        await atualizarDashboard();
    }

    // Fun√ß√µes para gerenciamento de formata√ß√£o e valida√ß√£o (opcional)
    // Exemplo: Formatar campos de telefone e CNPJ
    function formatarTelefone(input) {
        let telefone = input.value.replace(/\D/g, '');
        telefone = telefone.replace(/^(\d{2})(\d)/g, '($1) $2');
        telefone = telefone.replace(/(\d)(\d{4})$/, '$1-$2');
        input.value = telefone;
    }

    function formatarCNPJ(input) {
        let cnpj = input.value.replace(/\D/g, '');
        cnpj = cnpj.replace(/^(\d{2})(\d)/, '$1.$2');
        cnpj = cnpj.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        cnpj = cnpj.replace(/\.(\d{3})(\d)/, '.$1/$2');
        cnpj = cnpj.replace(/(\d{4})(\d)/, '$1-$2');
        input.value = cnpj;
    }

    // Adicionar eventos de input para formata√ß√£o
    document.getElementById('telefone_empresa').addEventListener('input', function() {
        formatarTelefone(this);
    });

    document.getElementById('telefone_cliente').addEventListener('input', function() {
        formatarTelefone(this);
    });

    document.getElementById('telefone_cliente_edit').addEventListener('input', function() {
        formatarTelefone(this);
    });

    document.getElementById('cnpj_empresa').addEventListener('input', function() {
        formatarCNPJ(this);
    });

    // Fun√ß√£o para gerenciar a navega√ß√£o entre se√ß√µes no menu
    function showSection(sectionId) {
        // Esconder todas as se√ß√µes
        document.querySelectorAll('.section').forEach(function(section) {
            section.style.display = 'none';
        });

        // Mostrar a se√ß√£o selecionada
        var targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.style.display = 'block';
        }

        // Fechar o sidenav no mobile
        var sidenav = M.Sidenav.getInstance(document.querySelector('.sidenav'));
        if (sidenav && window.innerWidth < 992) { // 992px √© o breakpoint padr√£o do Materialize para desktop
            sidenav.close();
        }
    }

    // Inicializar a exibi√ß√£o das se√ß√µes





// Event listeners para navega√ß√£o no sidenav e navbar, excluindo dropdown-trigger e modal-link
document.querySelectorAll('.sidenav a[href^="#"]:not(.dropdown-trigger):not(.modal-link), .nav-wrapper a[href^="#"]:not(.dropdown-trigger):not(.modal-link)').forEach(function(el) {
    el.addEventListener('click', function(e) {
        e.preventDefault();
        var targetId = this.getAttribute('href').substring(1);
        showSection(targetId);
    });
});

    




    
    // Fun√ß√£o para carregar dados do formul√°rio de or√ßamento ao selecionar um ano
    $anoSelect.addEventListener('change', async function() {
        const anoId = this.value;
        const modeloId = $modeloSelect.value;
        const marcaId = $marcaSelect.value;
        if (anoId && modeloId && marcaId) {
            try {
                const vehicleData = await fetchFipeData(`/marcas/${marcaId}/modelos/${modeloId}/anos/${anoId}`);
                if (vehicleData) {
                    console.log('Dados do ve√≠culo:', vehicleData);
                    // Aqui voc√™ pode adicionar l√≥gica adicional para usar os dados do ve√≠culo
                }
            } catch (error) {
                console.error('Erro ao buscar dados do ve√≠culo:', error);
            }
        }
    });

    // Fun√ß√£o para carregar e atualizar os selects de forma din√¢mica
    async function carregarSelects() {
        await carregarClientes();
        await carregarServicos();
        M.FormSelect.init(document.querySelectorAll('select'));
    }

    // Atualizar selects sempre que novos dados s√£o adicionados
    async function carregarDados() {
        await carregarClientes();
        await carregarServicos();
        await carregarOrcamentos();
        atualizarDashboard();
    }

// Inicializa√ß√£o quando o documento estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    initializeAllComponents();
    carregarSelects();
    loadBrands();
    carregarDados();

    // Adicionar evento ao bot√£o de calcular or√ßamento
    document.getElementById('calcularOrcamentoBtn').addEventListener('click', calcularOrcamento);

    // Event listeners para navega√ß√£o no sidenav e navbar, excluindo dropdown-trigger e modal-link
    document.querySelectorAll('.sidenav a[href^="#"]:not(.dropdown-trigger):not(.modal-link), .nav-wrapper a[href^="#"]:not(.dropdown-trigger):not(.modal-link)').forEach(function(el) {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            var targetId = this.getAttribute('href').substring(1);
            showSection(targetId);
        });
    });
});



</script>
</body>
</html>
